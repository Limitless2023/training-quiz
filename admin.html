<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç®¡ç†åå° - åŸ¹è®­è€ƒæ ¸ç³»ç»Ÿ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    .tab-btn { transition: all 0.2s; }
    .tab-btn.active { color: #4f46e5; border-bottom: 2px solid #4f46e5; }
    .tab-content { display: none; opacity: 0; transition: opacity 0.2s; }
    .tab-content.active { display: block; opacity: 1; }
    .modal-overlay { background: rgba(0,0,0,0.4); }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">

  <!-- ========== å¯†ç éªŒè¯é¡µ ========== -->
  <div id="auth-wall" class="min-h-screen flex items-center justify-center px-4">
    <div class="w-full max-w-sm">
      <div class="text-center mb-8">
        <div class="w-16 h-16 bg-indigo-600 rounded-2xl flex items-center justify-center mx-auto mb-4">
          <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
          </svg>
        </div>
        <h1 class="text-2xl font-bold text-gray-900">ç®¡ç†åå°</h1>
        <p class="text-gray-500 mt-1">è¯·è¾“å…¥ç®¡ç†å¯†ç </p>
      </div>
      <div class="bg-white rounded-2xl shadow-sm border p-6 space-y-4">
        <input id="admin-password" type="password" placeholder="è¾“å…¥å¯†ç "
          class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none"
          onkeydown="if(event.key==='Enter')checkPassword()">
        <button onclick="checkPassword()"
          class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-medium transition">
          è¿›å…¥
        </button>
        <div id="auth-error" class="text-red-500 text-sm text-center hidden">å¯†ç é”™è¯¯</div>
      </div>
    </div>
  </div>

  <!-- ========== ç®¡ç†é¢æ¿ ========== -->
  <div id="admin-panel" class="hidden">
    <!-- é¡¶éƒ¨æ  -->
    <div class="bg-white border-b sticky top-0 z-20">
      <div class="max-w-6xl mx-auto px-4">
        <div class="flex items-center justify-between py-3">
          <h1 class="text-lg font-bold text-gray-900">ğŸ“Š ç®¡ç†åå°</h1>
          <div class="flex items-center gap-3">
            <a href="index.html" class="text-sm text-indigo-600 hover:underline">â† ç”¨æˆ·ç«¯</a>
            <button onclick="adminLogout()" class="text-sm text-gray-500 hover:text-gray-700">é€€å‡º</button>
          </div>
        </div>
        <!-- Tab å¯¼èˆª -->
        <div class="flex gap-1 overflow-x-auto -mb-px">
          <button class="tab-btn active px-4 py-2.5 text-sm font-medium whitespace-nowrap" onclick="switchTab('dashboard')">ä»ªè¡¨ç›˜</button>
          <button class="tab-btn px-4 py-2.5 text-sm font-medium text-gray-500 whitespace-nowrap" onclick="switchTab('department')">æŒ‰éƒ¨é—¨</button>
          <button class="tab-btn px-4 py-2.5 text-sm font-medium text-gray-500 whitespace-nowrap" onclick="switchTab('member')">æŒ‰æˆå‘˜</button>
          <button class="tab-btn px-4 py-2.5 text-sm font-medium text-gray-500 whitespace-nowrap" onclick="switchTab('manage')">é¢˜ç›®ç®¡ç†</button>
          <button class="tab-btn px-4 py-2.5 text-sm font-medium text-gray-500 whitespace-nowrap" onclick="switchTab('export')">å¯¼å‡º</button>
        </div>
      </div>
    </div>

    <div class="max-w-6xl mx-auto px-4 py-6">

      <!-- ===== ä»ªè¡¨ç›˜ Tab ===== -->
      <div id="tab-dashboard" class="tab-content active">
        <div id="dashboard-loading" class="text-center py-20 text-gray-400">
          <div class="inline-block w-8 h-8 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin"></div>
        </div>
        <div id="dashboard-content" class="hidden">
          <!-- æ±‡æ€»å¡ç‰‡ -->
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white rounded-xl border p-4">
              <div class="text-sm text-gray-500">æ€»è€ƒæ ¸æ•°</div>
              <div id="stat-quizzes" class="text-2xl font-bold text-gray-900 mt-1">0</div>
            </div>
            <div class="bg-white rounded-xl border p-4">
              <div class="text-sm text-gray-500">æ€»å‚ä¸äººæ•°</div>
              <div id="stat-participants" class="text-2xl font-bold text-gray-900 mt-1">0</div>
            </div>
            <div class="bg-white rounded-xl border p-4">
              <div class="text-sm text-gray-500">å¹³å‡åˆ†</div>
              <div id="stat-avg" class="text-2xl font-bold text-indigo-600 mt-1">0</div>
            </div>
            <div class="bg-white rounded-xl border p-4">
              <div class="text-sm text-gray-500">é€šè¿‡ç‡</div>
              <div id="stat-pass-rate" class="text-2xl font-bold text-green-600 mt-1">0%</div>
            </div>
          </div>
          <!-- è€ƒæ ¸è¡¨æ ¼ -->
          <div class="bg-white rounded-xl border overflow-hidden">
            <div class="p-4 border-b">
              <h3 class="font-bold text-gray-900">å„åœºè€ƒæ ¸ç»Ÿè®¡</h3>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="text-left px-4 py-3 font-medium text-gray-500">è€ƒæ ¸åç§°</th>
                    <th class="text-center px-4 py-3 font-medium text-gray-500">æ—¥æœŸ</th>
                    <th class="text-center px-4 py-3 font-medium text-gray-500">å‚ä¸äººæ•°</th>
                    <th class="text-center px-4 py-3 font-medium text-gray-500">å¹³å‡åˆ†</th>
                    <th class="text-center px-4 py-3 font-medium text-gray-500">é€šè¿‡ç‡</th>
                  </tr>
                </thead>
                <tbody id="dashboard-table"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- ===== æŒ‰éƒ¨é—¨ Tab ===== -->
      <div id="tab-department" class="tab-content">
        <div class="bg-white rounded-xl border p-4 mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">é€‰æ‹©è€ƒæ ¸</label>
          <select id="dept-quiz-select" onchange="loadDepartmentStats()"
            class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none bg-white">
            <option value="">-- è¯·é€‰æ‹© --</option>
          </select>
        </div>
        <div id="dept-content" class="hidden">
          <div class="bg-white rounded-xl border overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="text-left px-4 py-3 font-medium text-gray-500">éƒ¨é—¨</th>
                    <th class="text-center px-4 py-3 font-medium text-gray-500">å‚ä¸äººæ•°</th>
                    <th class="text-center px-4 py-3 font-medium text-gray-500">å¹³å‡åˆ†</th>
                    <th class="text-center px-4 py-3 font-medium text-gray-500">é€šè¿‡ç‡</th>
                  </tr>
                </thead>
                <tbody id="dept-table"></tbody>
              </table>
            </div>
          </div>
        </div>
        <div id="dept-empty" class="hidden text-center py-10 text-gray-400">è¯·é€‰æ‹©ä¸€ä¸ªè€ƒæ ¸</div>
      </div>

      <!-- ===== æŒ‰æˆå‘˜ Tab ===== -->
      <div id="tab-member" class="tab-content">
        <div class="bg-white rounded-xl border p-4 mb-4">
          <input id="member-search" type="text" placeholder="æœç´¢å§“å..." oninput="searchMembers()"
            class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none">
        </div>
        <div id="member-content" class="bg-white rounded-xl border overflow-hidden">
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead class="bg-gray-50">
                <tr>
                  <th class="text-left px-4 py-3 font-medium text-gray-500">å§“å</th>
                  <th class="text-left px-4 py-3 font-medium text-gray-500">éƒ¨é—¨</th>
                  <th class="text-left px-4 py-3 font-medium text-gray-500">è€ƒæ ¸åç§°</th>
                  <th class="text-center px-4 py-3 font-medium text-gray-500">åˆ†æ•°</th>
                  <th class="text-center px-4 py-3 font-medium text-gray-500">ç­”å¯¹/æ€»é¢˜</th>
                  <th class="text-center px-4 py-3 font-medium text-gray-500">æ—¶é—´</th>
                </tr>
              </thead>
              <tbody id="member-table"></tbody>
            </table>
          </div>
        </div>
        <div id="member-empty" class="hidden text-center py-10 text-gray-400">æš‚æ— æ•°æ®</div>
      </div>

      <!-- ===== é¢˜ç›®ç®¡ç† Tab ===== -->
      <div id="tab-manage" class="tab-content">
        <div class="grid md:grid-cols-3 gap-4">
          <!-- å·¦ä¾§ï¼šè€ƒæ ¸åˆ—è¡¨ -->
          <div class="bg-white rounded-xl border overflow-hidden">
            <div class="p-4 border-b flex items-center justify-between">
              <h3 class="font-bold text-gray-900">è€ƒæ ¸åˆ—è¡¨</h3>
              <button onclick="showQuizForm()" class="text-sm px-3 py-1.5 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">+ æ–°å¢</button>
            </div>
            <div id="manage-quiz-list" class="divide-y max-h-[60vh] overflow-y-auto">
              <!-- åŠ¨æ€ -->
            </div>
          </div>
          <!-- å³ä¾§ï¼šé¢˜ç›®åˆ—è¡¨ -->
          <div class="md:col-span-2 bg-white rounded-xl border overflow-hidden">
            <div class="p-4 border-b flex items-center justify-between">
              <h3 class="font-bold text-gray-900" id="manage-quiz-title">è¯·é€‰æ‹©è€ƒæ ¸</h3>
              <button id="btn-add-question" onclick="showQuestionForm()" class="hidden text-sm px-3 py-1.5 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">+ æ–°å¢é¢˜ç›®</button>
            </div>
            <div id="manage-questions" class="divide-y max-h-[60vh] overflow-y-auto">
              <div class="p-10 text-center text-gray-400">â† è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè€ƒæ ¸</div>
            </div>
          </div>
        </div>
      </div>

      <!-- ===== å¯¼å‡º Tab ===== -->
      <div id="tab-export" class="tab-content">
        <div class="bg-white rounded-xl border p-6 max-w-md mx-auto">
          <h3 class="font-bold text-gray-900 mb-4">å¯¼å‡ºè€ƒæ ¸æˆç»©</h3>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">é€‰æ‹©è€ƒæ ¸</label>
              <select id="export-quiz-select"
                class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none bg-white">
                <option value="">-- è¯·é€‰æ‹© --</option>
              </select>
            </div>
            <button onclick="exportCSV()"
              class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-medium transition">
              ğŸ“¥ å¯¼å‡º CSV
            </button>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- ========== æ¨¡æ€æ¡†ï¼šæ–°å¢/ç¼–è¾‘è€ƒæ ¸ ========== -->
  <div id="modal-quiz" class="fixed inset-0 z-50 hidden items-center justify-center p-4" style="display:none;">
    <div class="modal-overlay absolute inset-0" onclick="closeModal('modal-quiz')"></div>
    <div class="relative bg-white rounded-2xl shadow-xl w-full max-w-md p-6 z-10 max-h-[90vh] overflow-y-auto">
      <h3 id="modal-quiz-title" class="text-lg font-bold mb-4">æ–°å¢è€ƒæ ¸</h3>
      <input type="hidden" id="quiz-form-id">
      <div class="space-y-3">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">è€ƒæ ¸æ ‡é¢˜ *</label>
          <input id="quiz-form-title" type="text" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">æ—¥æœŸ</label>
            <input id="quiz-form-date" type="date" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">åŸ¹è®­å¸ˆ</label>
            <input id="quiz-form-trainer" type="text" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">æè¿°</label>
          <textarea id="quiz-form-desc" rows="2" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none"></textarea>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">åˆæ ¼çº¿</label>
            <input id="quiz-form-passing" type="number" value="70" min="0" max="100" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">çŠ¶æ€</label>
            <select id="quiz-form-active" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none bg-white">
              <option value="true">å·²æ¿€æ´»</option>
              <option value="false">æœªæ¿€æ´»</option>
            </select>
          </div>
        </div>
      </div>
      <div class="flex gap-3 mt-6">
        <button onclick="closeModal('modal-quiz')" class="flex-1 py-2.5 border rounded-lg hover:bg-gray-50">å–æ¶ˆ</button>
        <button onclick="saveQuiz()" class="flex-1 py-2.5 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <!-- ========== æ¨¡æ€æ¡†ï¼šæ–°å¢/ç¼–è¾‘é¢˜ç›® ========== -->
  <div id="modal-question" class="fixed inset-0 z-50 hidden items-center justify-center p-4" style="display:none;">
    <div class="modal-overlay absolute inset-0" onclick="closeModal('modal-question')"></div>
    <div class="relative bg-white rounded-2xl shadow-xl w-full max-w-lg p-6 z-10 max-h-[90vh] overflow-y-auto">
      <h3 id="modal-question-title" class="text-lg font-bold mb-4">æ–°å¢é¢˜ç›®</h3>
      <input type="hidden" id="question-form-id">
      <div class="space-y-3">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">é¢˜å‹ *</label>
          <select id="question-form-type" onchange="onQuestionTypeChange()"
            class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none bg-white">
            <option value="single">å•é€‰</option>
            <option value="multiple">å¤šé€‰</option>
            <option value="truefalse">åˆ¤æ–­</option>
            <option value="fill">å¡«ç©º</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">é¢˜ç›® *</label>
          <textarea id="question-form-text" rows="3" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none"></textarea>
        </div>
        <!-- é€‰é¡¹åŒºåŸŸï¼ˆå•é€‰/å¤šé€‰ï¼‰ -->
        <div id="options-area">
          <label class="block text-sm font-medium text-gray-700 mb-1">é€‰é¡¹</label>
          <div id="options-list" class="space-y-2">
            <!-- åŠ¨æ€ -->
          </div>
          <button onclick="addOption()" class="mt-2 text-sm text-indigo-600 hover:underline">+ æ·»åŠ é€‰é¡¹</button>
        </div>
        <!-- ç­”æ¡ˆåŒºåŸŸ -->
        <div id="answer-area">
          <label class="block text-sm font-medium text-gray-700 mb-1">æ­£ç¡®ç­”æ¡ˆ *</label>
          <div id="answer-input">
            <!-- æ ¹æ®é¢˜å‹åŠ¨æ€åˆ‡æ¢ -->
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">æ’åºå·</label>
          <input id="question-form-order" type="number" value="0" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">è§£æ</label>
          <textarea id="question-form-explanation" rows="2" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none"></textarea>
        </div>
      </div>
      <div class="flex gap-3 mt-6">
        <button onclick="closeModal('modal-question')" class="flex-1 py-2.5 border rounded-lg hover:bg-gray-50">å–æ¶ˆ</button>
        <button onclick="saveQuestion()" class="flex-1 py-2.5 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">ä¿å­˜</button>
      </div>
    </div>
  </div>

<script>
// ============================================
// Supabase åˆå§‹åŒ–
// ============================================
const SUPABASE_URL = 'https://qdipqdysblxckgkcpnqj.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFkaXBxZHlzYmx4Y2tna2NwbnFqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzMDA0NDIsImV4cCI6MjA4NTg3NjQ0Mn0.x0_AQz7tcfvt6s3CdyHfnsBFFDkY32IA1W-7eidxvXs';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const ADMIN_PASSWORD = 'powerlaw2026';

// ============================================
// å…¨å±€ç¼“å­˜
// ============================================
let allQuizzes = [];
let allAttempts = [];
let allProfiles = [];
let selectedManageQuizId = null;

// ============================================
// å¯†ç éªŒè¯
// ============================================
function checkPassword() {
  const pwd = document.getElementById('admin-password').value;
  if (pwd === ADMIN_PASSWORD) {
    sessionStorage.setItem('admin_auth', 'true');
    showAdminPanel();
  } else {
    document.getElementById('auth-error').classList.remove('hidden');
  }
}

function showAdminPanel() {
  document.getElementById('auth-wall').style.display = 'none';
  document.getElementById('admin-panel').classList.remove('hidden');
  loadAllData();
}

function adminLogout() {
  sessionStorage.removeItem('admin_auth');
  location.reload();
}

// åˆå§‹åŒ–æ£€æŸ¥
if (sessionStorage.getItem('admin_auth') === 'true') {
  showAdminPanel();
}

// ============================================
// Tab åˆ‡æ¢
// ============================================
function switchTab(tab) {
  document.querySelectorAll('.tab-btn').forEach(b => {
    b.classList.remove('active');
    b.classList.add('text-gray-500');
  });
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  event.target.classList.add('active');
  event.target.classList.remove('text-gray-500');
  const content = document.getElementById('tab-' + tab);
  if (content) setTimeout(() => content.classList.add('active'), 10);

  // æŒ‰éœ€åŠ è½½
  switch(tab) {
    case 'dashboard': renderDashboard(); break;
    case 'department': populateQuizSelects(); break;
    case 'member': loadMembers(); break;
    case 'manage': loadManageQuizzes(); break;
    case 'export': populateQuizSelects(); break;
  }
}

// ============================================
// åŠ è½½å…¨éƒ¨æ•°æ®
// ============================================
async function loadAllData() {
  try {
    const [quizRes, attRes, profRes] = await Promise.all([
      supabase.from('quizzes').select('*').order('created_at', { ascending: false }),
      supabase.from('attempts').select('*'),
      supabase.from('profiles').select('*')
    ]);
    if (quizRes.error) throw quizRes.error;
    if (attRes.error) throw attRes.error;
    if (profRes.error) throw profRes.error;

    allQuizzes = quizRes.data || [];
    allAttempts = attRes.data || [];
    allProfiles = profRes.data || [];

    renderDashboard();
    populateQuizSelects();
  } catch (err) {
    console.error('åŠ è½½æ•°æ®å¤±è´¥:', err);
    alert('åŠ è½½æ•°æ®å¤±è´¥: ' + (err.message || 'ç½‘ç»œé”™è¯¯'));
  }
}

// ============================================
// ä»ªè¡¨ç›˜
// ============================================
function renderDashboard() {
  document.getElementById('dashboard-loading').classList.add('hidden');
  document.getElementById('dashboard-content').classList.remove('hidden');

  const totalQuizzes = allQuizzes.length;
  const uniqueUsers = new Set(allAttempts.map(a => a.user_id)).size;
  const avgScore = allAttempts.length > 0
    ? Math.round(allAttempts.reduce((s, a) => s + a.score, 0) / allAttempts.length)
    : 0;

  // è®¡ç®—é€šè¿‡ç‡éœ€è¦æ¯ä¸ª quiz çš„ passing_score
  const quizMap = {};
  allQuizzes.forEach(q => { quizMap[q.id] = q; });
  const passCount = allAttempts.filter(a => {
    const q = quizMap[a.quiz_id];
    return q && a.score >= q.passing_score;
  }).length;
  const passRate = allAttempts.length > 0 ? Math.round((passCount / allAttempts.length) * 100) : 0;

  document.getElementById('stat-quizzes').textContent = totalQuizzes;
  document.getElementById('stat-participants').textContent = uniqueUsers;
  document.getElementById('stat-avg').textContent = avgScore;
  document.getElementById('stat-pass-rate').textContent = passRate + '%';

  // æ¯åœºè€ƒæ ¸ç»Ÿè®¡
  const tbody = document.getElementById('dashboard-table');
  tbody.innerHTML = '';
  allQuizzes.forEach(quiz => {
    const qAttempts = allAttempts.filter(a => a.quiz_id === quiz.id);
    const count = qAttempts.length;
    const avg = count > 0 ? Math.round(qAttempts.reduce((s, a) => s + a.score, 0) / count) : '-';
    const pass = count > 0 ? Math.round(qAttempts.filter(a => a.score >= quiz.passing_score).length / count * 100) + '%' : '-';
    tbody.innerHTML += `
      <tr class="border-t hover:bg-gray-50">
        <td class="px-4 py-3 font-medium text-gray-900">${escHtml(quiz.title)}</td>
        <td class="px-4 py-3 text-center text-gray-500">${quiz.date || '-'}</td>
        <td class="px-4 py-3 text-center">${count}</td>
        <td class="px-4 py-3 text-center font-medium text-indigo-600">${avg}</td>
        <td class="px-4 py-3 text-center font-medium text-green-600">${pass}</td>
      </tr>
    `;
  });
  if (allQuizzes.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-10 text-center text-gray-400">æš‚æ— è€ƒæ ¸æ•°æ®</td></tr>';
  }
}

// ============================================
// å¡«å……è€ƒæ ¸ä¸‹æ‹‰æ¡†
// ============================================
function populateQuizSelects() {
  const html = allQuizzes.map(q => `<option value="${q.id}">${escHtml(q.title)}</option>`).join('');
  ['dept-quiz-select', 'export-quiz-select'].forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      const current = el.value;
      el.innerHTML = '<option value="">-- è¯·é€‰æ‹© --</option>' + html;
      if (current) el.value = current;
    }
  });
}

// ============================================
// æŒ‰éƒ¨é—¨ç»Ÿè®¡
// ============================================
function loadDepartmentStats() {
  const quizId = document.getElementById('dept-quiz-select').value;
  const contentEl = document.getElementById('dept-content');
  const emptyEl = document.getElementById('dept-empty');

  if (!quizId) {
    contentEl.classList.add('hidden');
    emptyEl.classList.remove('hidden');
    return;
  }

  contentEl.classList.remove('hidden');
  emptyEl.classList.add('hidden');

  const quiz = allQuizzes.find(q => q.id === quizId);
  const qAttempts = allAttempts.filter(a => a.quiz_id === quizId);

  // æŒ‰ç”¨æˆ·åˆ†ç»„ï¼Œå–æ¯ç”¨æˆ·æœ€é«˜åˆ†
  const userBest = {};
  qAttempts.forEach(a => {
    if (!userBest[a.user_id] || a.score > userBest[a.user_id].score) {
      userBest[a.user_id] = a;
    }
  });

  // æŒ‰éƒ¨é—¨æ±‡æ€»
  const profMap = {};
  allProfiles.forEach(p => { profMap[p.id] = p; });

  const deptStats = {};
  Object.values(userBest).forEach(a => {
    const prof = profMap[a.user_id];
    if (!prof) return;
    const dept = prof.department;
    if (!deptStats[dept]) deptStats[dept] = { scores: [], count: 0 };
    deptStats[dept].scores.push(a.score);
    deptStats[dept].count++;
  });

  const tbody = document.getElementById('dept-table');
  tbody.innerHTML = '';

  const depts = Object.keys(deptStats).sort();
  if (depts.length === 0) {
    tbody.innerHTML = '<tr><td colspan="4" class="px-4 py-10 text-center text-gray-400">æš‚æ— æ•°æ®</td></tr>';
    return;
  }

  depts.forEach(dept => {
    const stat = deptStats[dept];
    const avg = Math.round(stat.scores.reduce((s, v) => s + v, 0) / stat.count);
    const pass = Math.round(stat.scores.filter(s => s >= quiz.passing_score).length / stat.count * 100);
    tbody.innerHTML += `
      <tr class="border-t hover:bg-gray-50">
        <td class="px-4 py-3 font-medium text-gray-900">${escHtml(dept)}</td>
        <td class="px-4 py-3 text-center">${stat.count}</td>
        <td class="px-4 py-3 text-center font-medium text-indigo-600">${avg}</td>
        <td class="px-4 py-3 text-center font-medium text-green-600">${pass}%</td>
      </tr>
    `;
  });
}

// ============================================
// æŒ‰æˆå‘˜
// ============================================
let memberData = [];

async function loadMembers() {
  const profMap = {};
  allProfiles.forEach(p => { profMap[p.id] = p; });
  const quizMap = {};
  allQuizzes.forEach(q => { quizMap[q.id] = q; });

  memberData = allAttempts.map(a => ({
    name: profMap[a.user_id]?.name || 'æœªçŸ¥',
    department: profMap[a.user_id]?.department || '-',
    quiz: quizMap[a.quiz_id]?.title || 'æœªçŸ¥è€ƒæ ¸',
    score: a.score,
    correct: a.correct_count,
    total: a.total,
    time: a.completed_at ? new Date(a.completed_at).toLocaleString('zh-CN') : '-'
  })).sort((a, b) => a.name.localeCompare(b.name, 'zh'));

  renderMembers(memberData);
}

function searchMembers() {
  const q = document.getElementById('member-search').value.trim().toLowerCase();
  const filtered = q ? memberData.filter(m => m.name.toLowerCase().includes(q)) : memberData;
  renderMembers(filtered);
}

function renderMembers(data) {
  const tbody = document.getElementById('member-table');
  const emptyEl = document.getElementById('member-empty');

  if (data.length === 0) {
    tbody.innerHTML = '';
    emptyEl.classList.remove('hidden');
    document.getElementById('member-content').classList.add('hidden');
    return;
  }

  emptyEl.classList.add('hidden');
  document.getElementById('member-content').classList.remove('hidden');

  tbody.innerHTML = data.map(m => `
    <tr class="border-t hover:bg-gray-50">
      <td class="px-4 py-3 font-medium text-gray-900">${escHtml(m.name)}</td>
      <td class="px-4 py-3 text-gray-500">${escHtml(m.department)}</td>
      <td class="px-4 py-3 text-gray-700">${escHtml(m.quiz)}</td>
      <td class="px-4 py-3 text-center font-medium ${m.score >= 70 ? 'text-green-600' : 'text-red-500'}">${m.score}</td>
      <td class="px-4 py-3 text-center text-gray-500">${m.correct}/${m.total}</td>
      <td class="px-4 py-3 text-center text-gray-400 text-xs">${m.time}</td>
    </tr>
  `).join('');
}

// ============================================
// é¢˜ç›®ç®¡ç†
// ============================================
async function loadManageQuizzes() {
  const listEl = document.getElementById('manage-quiz-list');
  listEl.innerHTML = '';
  allQuizzes.forEach(quiz => {
    const div = document.createElement('div');
    div.className = `p-3 cursor-pointer hover:bg-indigo-50 transition ${selectedManageQuizId === quiz.id ? 'bg-indigo-50 border-l-4 border-indigo-600' : ''}`;
    div.onclick = () => selectManageQuiz(quiz.id);
    div.innerHTML = `
      <div class="font-medium text-sm text-gray-900 truncate">${escHtml(quiz.title)}</div>
      <div class="text-xs text-gray-400 mt-0.5">${quiz.date || 'æœªè®¾ç½®æ—¥æœŸ'} Â· ${quiz.is_active ? 'å·²æ¿€æ´»' : 'æœªæ¿€æ´»'}</div>
    `;
    listEl.appendChild(div);
  });
  if (allQuizzes.length === 0) {
    listEl.innerHTML = '<div class="p-4 text-center text-gray-400 text-sm">æš‚æ— è€ƒæ ¸</div>';
  }
}

async function selectManageQuiz(quizId) {
  selectedManageQuizId = quizId;
  loadManageQuizzes(); // åˆ·æ–°é«˜äº®

  const quiz = allQuizzes.find(q => q.id === quizId);
  document.getElementById('manage-quiz-title').textContent = quiz ? quiz.title : 'é¢˜ç›®ç®¡ç†';
  document.getElementById('btn-add-question').classList.remove('hidden');

  const questionsEl = document.getElementById('manage-questions');
  questionsEl.innerHTML = '<div class="p-10 text-center text-gray-400"><div class="inline-block w-6 h-6 border-2 border-indigo-200 border-t-indigo-600 rounded-full animate-spin"></div></div>';

  try {
    const { data: questions, error } = await supabase
      .from('questions')
      .select('*')
      .eq('quiz_id', quizId)
      .order('order_num', { ascending: true });
    if (error) throw error;

    if (!questions || questions.length === 0) {
      questionsEl.innerHTML = '<div class="p-10 text-center text-gray-400">æš‚æ— é¢˜ç›®ï¼Œç‚¹å‡»ã€Œæ–°å¢é¢˜ç›®ã€å¼€å§‹æ·»åŠ </div>';
      return;
    }

    const typeLabels = { single: 'å•é€‰', multiple: 'å¤šé€‰', truefalse: 'åˆ¤æ–­', fill: 'å¡«ç©º' };
    questionsEl.innerHTML = '';
    questions.forEach((q, idx) => {
      const div = document.createElement('div');
      div.className = 'p-4 hover:bg-gray-50 transition';
      div.innerHTML = `
        <div class="flex items-start justify-between gap-2">
          <div class="flex-1 min-w-0">
            <div class="flex items-center gap-2 mb-1">
              <span class="text-xs text-gray-400">#${q.order_num || idx + 1}</span>
              <span class="text-xs px-1.5 py-0.5 rounded bg-gray-100 text-gray-600">${typeLabels[q.type] || q.type}</span>
            </div>
            <p class="text-sm text-gray-900 line-clamp-2">${escHtml(q.question)}</p>
          </div>
          <div class="flex gap-1 flex-shrink-0">
            <button onclick="editQuestion('${q.id}')" class="text-xs px-2 py-1 text-indigo-600 hover:bg-indigo-50 rounded">ç¼–è¾‘</button>
            <button onclick="deleteQuestion('${q.id}')" class="text-xs px-2 py-1 text-red-500 hover:bg-red-50 rounded">åˆ é™¤</button>
          </div>
        </div>
      `;
      questionsEl.appendChild(div);
    });
  } catch (err) {
    questionsEl.innerHTML = `<div class="p-10 text-center text-red-500">åŠ è½½å¤±è´¥: ${escHtml(err.message)}</div>`;
  }
}

// ============================================
// è€ƒæ ¸è¡¨å•
// ============================================
function showQuizForm(quizId) {
  const quiz = quizId ? allQuizzes.find(q => q.id === quizId) : null;
  document.getElementById('modal-quiz-title').textContent = quiz ? 'ç¼–è¾‘è€ƒæ ¸' : 'æ–°å¢è€ƒæ ¸';
  document.getElementById('quiz-form-id').value = quiz ? quiz.id : '';
  document.getElementById('quiz-form-title').value = quiz ? quiz.title : '';
  document.getElementById('quiz-form-date').value = quiz ? quiz.date || '' : '';
  document.getElementById('quiz-form-trainer').value = quiz ? quiz.trainer || '' : '';
  document.getElementById('quiz-form-desc').value = quiz ? quiz.description || '' : '';
  document.getElementById('quiz-form-passing').value = quiz ? quiz.passing_score : 70;
  document.getElementById('quiz-form-active').value = quiz ? String(quiz.is_active) : 'true';
  openModal('modal-quiz');
}

async function saveQuiz() {
  const id = document.getElementById('quiz-form-id').value;
  const title = document.getElementById('quiz-form-title').value.trim();
  if (!title) { alert('è¯·è¾“å…¥è€ƒæ ¸æ ‡é¢˜'); return; }

  const payload = {
    title,
    date: document.getElementById('quiz-form-date').value || null,
    trainer: document.getElementById('quiz-form-trainer').value.trim() || null,
    description: document.getElementById('quiz-form-desc').value.trim() || null,
    passing_score: parseInt(document.getElementById('quiz-form-passing').value) || 70,
    is_active: document.getElementById('quiz-form-active').value === 'true'
  };

  try {
    if (id) {
      const { error } = await supabase.from('quizzes').update(payload).eq('id', id);
      if (error) throw error;
    } else {
      const { error } = await supabase.from('quizzes').insert(payload);
      if (error) throw error;
    }
    closeModal('modal-quiz');
    await loadAllData();
    loadManageQuizzes();
  } catch (err) {
    alert('ä¿å­˜å¤±è´¥: ' + (err.message || 'ç½‘ç»œé”™è¯¯'));
  }
}

// ============================================
// é¢˜ç›®è¡¨å•
// ============================================
let editingQuestionData = null;

function showQuestionForm(questionId) {
  editingQuestionData = null;
  document.getElementById('modal-question-title').textContent = questionId ? 'ç¼–è¾‘é¢˜ç›®' : 'æ–°å¢é¢˜ç›®';
  document.getElementById('question-form-id').value = questionId || '';
  document.getElementById('question-form-type').value = 'single';
  document.getElementById('question-form-text').value = '';
  document.getElementById('question-form-order').value = 0;
  document.getElementById('question-form-explanation').value = '';

  if (questionId) {
    // å¼‚æ­¥åŠ è½½é¢˜ç›®æ•°æ®
    loadQuestionForEdit(questionId);
  } else {
    onQuestionTypeChange();
    openModal('modal-question');
  }
}

async function loadQuestionForEdit(questionId) {
  try {
    const { data: q, error } = await supabase.from('questions').select('*').eq('id', questionId).single();
    if (error) throw error;

    editingQuestionData = q;
    document.getElementById('question-form-id').value = q.id;
    document.getElementById('question-form-type').value = q.type;
    document.getElementById('question-form-text').value = q.question;
    document.getElementById('question-form-order').value = q.order_num || 0;
    document.getElementById('question-form-explanation').value = q.explanation || '';

    onQuestionTypeChange();

    // å¡«å……é€‰é¡¹
    const options = q.options ? (typeof q.options === 'string' ? JSON.parse(q.options) : q.options) : [];
    if (q.type === 'single' || q.type === 'multiple') {
      const optList = document.getElementById('options-list');
      optList.innerHTML = '';
      options.forEach((opt, i) => addOption(opt));
    }

    // å¡«å……ç­”æ¡ˆ
    const answer = typeof q.answer === 'string' ? JSON.parse(q.answer) : q.answer;
    switch(q.type) {
      case 'single': {
        const radio = document.querySelector(`input[name="q_answer_single"][value="${answer}"]`);
        if (radio) radio.checked = true;
        break;
      }
      case 'multiple': {
        const indices = Array.isArray(answer) ? answer : [];
        indices.forEach(i => {
          const cb = document.querySelector(`input[data-answer-multi][value="${i}"]`);
          if (cb) cb.checked = true;
        });
        break;
      }
      case 'truefalse': {
        const sel = document.getElementById('answer-truefalse');
        if (sel) sel.value = String(answer);
        break;
      }
      case 'fill': {
        const inp = document.getElementById('answer-fill');
        if (inp) inp.value = String(answer);
        break;
      }
    }

    openModal('modal-question');
  } catch (err) {
    alert('åŠ è½½é¢˜ç›®å¤±è´¥: ' + err.message);
  }
}

function onQuestionTypeChange() {
  const type = document.getElementById('question-form-type').value;
  const optArea = document.getElementById('options-area');
  const answerInput = document.getElementById('answer-input');
  const optList = document.getElementById('options-list');

  // æ˜¾ç¤º/éšè—é€‰é¡¹åŒºåŸŸ
  if (type === 'single' || type === 'multiple') {
    optArea.style.display = 'block';
    if (optList.children.length === 0) {
      addOption(); addOption(); addOption(); addOption();
    }
  } else {
    optArea.style.display = 'none';
    optList.innerHTML = '';
  }

  // ç­”æ¡ˆè¾“å…¥åŒº
  switch(type) {
    case 'single':
      answerInput.innerHTML = `<p class="text-xs text-gray-400">é€‰é¡¹ç´¢å¼•ï¼ˆä» 0 å¼€å§‹ï¼‰</p>
        <div id="answer-single-radios" class="flex flex-wrap gap-2 mt-1"></div>`;
      updateAnswerRadios();
      break;
    case 'multiple':
      answerInput.innerHTML = `<p class="text-xs text-gray-400">å‹¾é€‰æ­£ç¡®é€‰é¡¹</p>
        <div id="answer-multi-checks" class="flex flex-wrap gap-2 mt-1"></div>`;
      updateAnswerChecks();
      break;
    case 'truefalse':
      answerInput.innerHTML = `<select id="answer-truefalse" class="w-full px-3 py-2 border rounded-lg bg-white">
        <option value="true">æ­£ç¡®</option><option value="false">é”™è¯¯</option></select>`;
      break;
    case 'fill':
      answerInput.innerHTML = `<input id="answer-fill" type="text" placeholder="æ­£ç¡®ç­”æ¡ˆæ–‡æœ¬" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">`;
      break;
  }
}

function addOption(value) {
  const list = document.getElementById('options-list');
  const idx = list.children.length;
  const div = document.createElement('div');
  div.className = 'flex items-center gap-2';
  div.innerHTML = `
    <span class="text-xs text-gray-400 w-5">${idx}</span>
    <input type="text" value="${escHtml(value || '')}" placeholder="é€‰é¡¹ ${idx}" class="flex-1 px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none option-input" oninput="updateAnswerRadios();updateAnswerChecks()">
    <button onclick="this.parentElement.remove();reindexOptions()" class="text-red-400 hover:text-red-600 text-sm px-1">âœ•</button>
  `;
  list.appendChild(div);
  updateAnswerRadios();
  updateAnswerChecks();
}

function reindexOptions() {
  const list = document.getElementById('options-list');
  Array.from(list.children).forEach((div, i) => {
    div.querySelector('span').textContent = i;
  });
  updateAnswerRadios();
  updateAnswerChecks();
}

function updateAnswerRadios() {
  const container = document.getElementById('answer-single-radios');
  if (!container) return;
  const opts = document.querySelectorAll('.option-input');
  container.innerHTML = '';
  opts.forEach((opt, i) => {
    container.innerHTML += `<label class="flex items-center gap-1 text-sm"><input type="radio" name="q_answer_single" value="${i}" class="text-indigo-600"> ${i}: ${escHtml(opt.value || 'é€‰é¡¹' + i)}</label>`;
  });
}

function updateAnswerChecks() {
  const container = document.getElementById('answer-multi-checks');
  if (!container) return;
  const opts = document.querySelectorAll('.option-input');
  container.innerHTML = '';
  opts.forEach((opt, i) => {
    container.innerHTML += `<label class="flex items-center gap-1 text-sm"><input type="checkbox" data-answer-multi value="${i}" class="text-indigo-600 rounded"> ${i}: ${escHtml(opt.value || 'é€‰é¡¹' + i)}</label>`;
  });
}

async function saveQuestion() {
  const id = document.getElementById('question-form-id').value;
  const type = document.getElementById('question-form-type').value;
  const question = document.getElementById('question-form-text').value.trim();
  const order_num = parseInt(document.getElementById('question-form-order').value) || 0;
  const explanation = document.getElementById('question-form-explanation').value.trim();

  if (!question) { alert('è¯·è¾“å…¥é¢˜ç›®'); return; }
  if (!selectedManageQuizId) { alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè€ƒæ ¸'); return; }

  // æ”¶é›†é€‰é¡¹
  let options = null;
  if (type === 'single' || type === 'multiple') {
    const optInputs = document.querySelectorAll('.option-input');
    options = Array.from(optInputs).map(i => i.value.trim()).filter(Boolean);
    if (options.length < 2) { alert('è‡³å°‘éœ€è¦2ä¸ªé€‰é¡¹'); return; }
  }

  // æ”¶é›†ç­”æ¡ˆ
  let answer = null;
  switch(type) {
    case 'single': {
      const checked = document.querySelector('input[name="q_answer_single"]:checked');
      if (!checked) { alert('è¯·é€‰æ‹©æ­£ç¡®ç­”æ¡ˆ'); return; }
      answer = parseInt(checked.value);
      break;
    }
    case 'multiple': {
      const checks = document.querySelectorAll('input[data-answer-multi]:checked');
      if (checks.length === 0) { alert('è¯·é€‰æ‹©æ­£ç¡®ç­”æ¡ˆ'); return; }
      answer = Array.from(checks).map(c => parseInt(c.value));
      break;
    }
    case 'truefalse':
      answer = document.getElementById('answer-truefalse').value === 'true';
      break;
    case 'fill':
      answer = document.getElementById('answer-fill').value.trim();
      if (!answer) { alert('è¯·è¾“å…¥æ­£ç¡®ç­”æ¡ˆ'); return; }
      break;
  }

  const payload = {
    quiz_id: selectedManageQuizId,
    type,
    question,
    options: options ? JSON.stringify(options) : null,
    answer: JSON.stringify(answer),
    explanation: explanation || null,
    order_num
  };

  try {
    if (id) {
      const { error } = await supabase.from('questions').update(payload).eq('id', id);
      if (error) throw error;
    } else {
      const { error } = await supabase.from('questions').insert(payload);
      if (error) throw error;
    }
    closeModal('modal-question');
    selectManageQuiz(selectedManageQuizId);
  } catch (err) {
    alert('ä¿å­˜å¤±è´¥: ' + (err.message || 'ç½‘ç»œé”™è¯¯'));
  }
}

function editQuestion(questionId) {
  showQuestionForm(questionId);
}

async function deleteQuestion(questionId) {
  if (!confirm('ç¡®å®šåˆ é™¤è¯¥é¢˜ç›®å—ï¼Ÿ')) return;
  try {
    const { error } = await supabase.from('questions').delete().eq('id', questionId);
    if (error) throw error;
    selectManageQuiz(selectedManageQuizId);
  } catch (err) {
    alert('åˆ é™¤å¤±è´¥: ' + err.message);
  }
}

// ============================================
// å¯¼å‡º CSV
// ============================================
async function exportCSV() {
  const quizId = document.getElementById('export-quiz-select').value;
  if (!quizId) { alert('è¯·é€‰æ‹©è€ƒæ ¸'); return; }

  const quiz = allQuizzes.find(q => q.id === quizId);
  const qAttempts = allAttempts.filter(a => a.quiz_id === quizId);

  if (qAttempts.length === 0) { alert('è¯¥è€ƒæ ¸æš‚æ— æˆç»©æ•°æ®'); return; }

  const profMap = {};
  allProfiles.forEach(p => { profMap[p.id] = p; });

  // BOM + CSV header
  let csv = '\uFEFFå§“å,éƒ¨é—¨,åˆ†æ•°,ç­”å¯¹æ•°,æ€»é¢˜æ•°,å®Œæˆæ—¶é—´\n';
  qAttempts.forEach(a => {
    const prof = profMap[a.user_id] || {};
    const time = a.completed_at ? new Date(a.completed_at).toLocaleString('zh-CN') : '';
    csv += `${csvEscape(prof.name || 'æœªçŸ¥')},${csvEscape(prof.department || '-')},${a.score},${a.correct_count},${a.total},${csvEscape(time)}\n`;
  });

  // ä¸‹è½½
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${quiz.title}_æˆç»©å¯¼å‡º.csv`;
  a.click();
  URL.revokeObjectURL(url);
}

function csvEscape(str) {
  if (!str) return '';
  str = String(str);
  if (str.includes(',') || str.includes('"') || str.includes('\n')) {
    return '"' + str.replace(/"/g, '""') + '"';
  }
  return str;
}

// ============================================
// æ¨¡æ€æ¡†æ§åˆ¶
// ============================================
function openModal(id) {
  const modal = document.getElementById(id);
  modal.style.display = 'flex';
  setTimeout(() => modal.classList.remove('hidden'), 10);
}

function closeModal(id) {
  const modal = document.getElementById(id);
  modal.classList.add('hidden');
  setTimeout(() => { modal.style.display = 'none'; }, 200);
}

// ============================================
// å·¥å…·å‡½æ•°
// ============================================
function escHtml(str) {
  if (!str) return '';
  const div = document.createElement('div');
  div.textContent = String(str);
  return div.innerHTML;
}
</script>
</body>
</html>
