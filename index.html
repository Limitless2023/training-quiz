<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åŸ¹è®­è€ƒæ ¸ç³»ç»Ÿ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <style>
    /* é¡µé¢åˆ‡æ¢ fade åŠ¨ç”» */
    .page { display: none; opacity: 0; transition: opacity 0.3s ease; }
    .page.active { display: block; opacity: 1; }
    /* åˆ†æ•°ç¯åŠ¨ç”» */
    @keyframes scoreRing { from { stroke-dashoffset: 283; } }
    .score-ring { animation: scoreRing 1s ease-out; }
    /* è¿›åº¦æ¡åŠ¨ç”» */
    .progress-bar { transition: width 0.3s ease; }
    /* æ’è¡Œæ¦œå±•å¼€ */
    .leaderboard-panel { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; }
    .leaderboard-panel.open { max-height: 600px; }
    /* è§£æå±•å¼€ */
    .analysis-panel { max-height: 0; overflow: hidden; transition: max-height 0.5s ease; }
    .analysis-panel.open { max-height: 5000px; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">

  <!-- ========== ç™»å½•é¡µ ========== -->
  <div id="page-login" class="page active">
    <div class="min-h-screen flex items-center justify-center px-4">
      <div class="w-full max-w-sm">
        <div class="text-center mb-8">
          <div class="w-16 h-16 bg-indigo-600 rounded-2xl flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
          </div>
          <h1 class="text-2xl font-bold text-gray-900">åŸ¹è®­è€ƒæ ¸ç³»ç»Ÿ</h1>
          <p class="text-gray-500 mt-1">è¯·è¾“å…¥ä¿¡æ¯å¼€å§‹è€ƒæ ¸</p>
        </div>
        <div class="bg-white rounded-2xl shadow-sm border p-6 space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">å§“å</label>
            <input id="login-name" type="text" placeholder="è¯·è¾“å…¥ä½ çš„å§“å"
              class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">éƒ¨é—¨</label>
            <select id="login-dept"
              class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition bg-white">
              <option value="">è¯·é€‰æ‹©éƒ¨é—¨</option>
              <option>äº§å“éƒ¨</option>
              <option>ç ”å‘éƒ¨</option>
              <option>å”®å‰éƒ¨</option>
              <option>é”€å”®éƒ¨</option>
              <option>äº¤ä»˜éƒ¨</option>
              <option>å®¢æˆ·æˆåŠŸéƒ¨</option>
              <option>å¸‚åœºéƒ¨</option>
              <option>æ³•åŠ¡éƒ¨</option>
              <option>è´¢åŠ¡éƒ¨</option>
              <option>å…¶ä»–</option>
            </select>
          </div>
          <button id="btn-login" onclick="handleLogin()"
            class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-medium transition active:scale-[0.98]">
            è¿›å…¥ç³»ç»Ÿ
          </button>
          <div id="login-error" class="text-red-500 text-sm text-center hidden"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ========== è€ƒæ ¸åˆ—è¡¨é¡µ ========== -->
  <div id="page-list" class="page">
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <div class="bg-white border-b sticky top-0 z-10">
      <div class="max-w-2xl mx-auto px-4 py-3 flex items-center justify-between">
        <h1 class="text-lg font-bold text-gray-900">åŸ¹è®­è€ƒæ ¸</h1>
        <div class="flex items-center gap-3">
          <span id="user-badge" class="text-sm text-gray-500"></span>
          <button onclick="handleLogout()" class="text-sm text-indigo-600 hover:text-indigo-800">é€€å‡º</button>
        </div>
      </div>
    </div>
    <div class="max-w-2xl mx-auto px-4 py-6">
      <div id="quiz-list" class="space-y-4">
        <!-- åŠ¨æ€å¡«å…… -->
      </div>
      <div id="quiz-list-empty" class="hidden text-center py-20 text-gray-400">
        <svg class="w-12 h-12 mx-auto mb-3 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 012-2h2a2 2 0 012 2M9 5h6"/>
        </svg>
        <p>æš‚æ— è€ƒæ ¸</p>
      </div>
      <div id="quiz-list-loading" class="text-center py-20 text-gray-400">
        <div class="inline-block w-8 h-8 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin"></div>
        <p class="mt-3">åŠ è½½ä¸­...</p>
      </div>
    </div>
  </div>

  <!-- ========== ç­”é¢˜é¡µ ========== -->
  <div id="page-quiz" class="page">
    <div class="bg-white border-b sticky top-0 z-10">
      <div class="max-w-2xl mx-auto px-4 py-3">
        <div class="flex items-center justify-between mb-2">
          <button onclick="confirmExit()" class="text-sm text-gray-500 hover:text-gray-700 flex items-center gap-1">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
            é€€å‡º
          </button>
          <span id="quiz-title-bar" class="text-sm font-medium text-gray-900 truncate mx-4"></span>
          <span id="quiz-progress-text" class="text-sm text-gray-500 whitespace-nowrap"></span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-2">
          <div id="quiz-progress-bar" class="progress-bar bg-indigo-600 h-2 rounded-full" style="width:0%"></div>
        </div>
      </div>
    </div>
    <div class="max-w-2xl mx-auto px-4 py-6">
      <div id="questions-container" class="space-y-6">
        <!-- åŠ¨æ€å¡«å…… -->
      </div>
      <div class="mt-8 pb-8">
        <button id="btn-submit" onclick="handleSubmit()"
          class="w-full py-4 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-medium text-lg transition active:scale-[0.98] disabled:opacity-50 disabled:cursor-not-allowed">
          æäº¤ç­”å·
        </button>
      </div>
    </div>
  </div>

  <!-- ========== ç»“æœé¡µ ========== -->
  <div id="page-result" class="page">
    <div class="max-w-2xl mx-auto px-4 py-8">
      <!-- åˆ†æ•°ç¯ -->
      <div class="text-center mb-8">
        <div class="relative inline-block">
          <svg width="160" height="160" viewBox="0 0 100 100">
            <circle cx="50" cy="50" r="45" fill="none" stroke="#e5e7eb" stroke-width="8"/>
            <circle id="score-circle" cx="50" cy="50" r="45" fill="none" stroke-width="8"
              stroke-linecap="round" transform="rotate(-90 50 50)"
              stroke-dasharray="283" stroke-dashoffset="283" class="score-ring"/>
          </svg>
          <div class="absolute inset-0 flex flex-col items-center justify-center">
            <span id="score-number" class="text-4xl font-bold"></span>
            <span class="text-sm text-gray-500">åˆ†</span>
          </div>
        </div>
        <div id="result-status" class="mt-4 text-xl font-bold"></div>
        <div id="result-stats" class="mt-2 text-gray-500"></div>
      </div>
      <!-- æ“ä½œæŒ‰é’® -->
      <div class="flex gap-3 mb-6">
        <button onclick="navigateTo('list')"
          class="flex-1 py-3 border-2 border-indigo-600 text-indigo-600 rounded-xl font-medium hover:bg-indigo-50 transition">
          è¿”å›åˆ—è¡¨
        </button>
        <button onclick="toggleAnalysis()"
          class="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-medium hover:bg-indigo-700 transition" id="btn-analysis">
          æŸ¥çœ‹è§£æ
        </button>
      </div>
      <!-- è§£æé¢æ¿ -->
      <div id="analysis-panel" class="analysis-panel">
        <div id="analysis-content" class="space-y-4 pb-8">
          <!-- åŠ¨æ€å¡«å…… -->
        </div>
      </div>
    </div>
  </div>

<script>
// ============================================
// Supabase åˆå§‹åŒ–
// ============================================
const SUPABASE_URL = 'https://qdipqdysblxckgkcpnqj.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFkaXBxZHlzYmx4Y2tna2NwbnFqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzMDA0NDIsImV4cCI6MjA4NTg3NjQ0Mn0.x0_AQz7tcfvt6s3CdyHfnsBFFDkY32IA1W-7eidxvXs';
let sb;
try {
  const mod = window.supabase;
  sb = (mod.createClient || mod.default?.createClient)(SUPABASE_URL, SUPABASE_ANON_KEY);
} catch(e) {
  console.error('Supabase SDK åŠ è½½å¤±è´¥:', e);
  document.addEventListener('DOMContentLoaded', () => {
    document.body.innerHTML = '<div style="padding:40px;text-align:center;color:red;">Supabase SDK åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</div>';
  });
}
const supabase = sb;

// ============================================
// å…¨å±€çŠ¶æ€
// ============================================
let currentUser = null;       // { id, name, department }
let currentQuiz = null;       // å½“å‰è€ƒæ ¸
let currentQuestions = [];    // å½“å‰é¢˜ç›®åˆ—è¡¨
let userAnswers = {};         // ç”¨æˆ·ç­”æ¡ˆ { questionId: answer }

// ============================================
// é¡µé¢è·¯ç”±
// ============================================
function navigateTo(page, data) {
  document.querySelectorAll('.page').forEach(p => {
    p.classList.remove('active');
  });
  const target = document.getElementById('page-' + page);
  if (target) {
    // çŸ­æš‚å»¶è¿Ÿä»¥è§¦å‘ fade åŠ¨ç”»
    setTimeout(() => target.classList.add('active'), 10);
  }
  // é¡µé¢åˆå§‹åŒ–
  switch(page) {
    case 'login': break;
    case 'list': loadQuizList(); break;
    case 'quiz': loadQuiz(data); break;
    case 'result': showResult(data); break;
  }
  // æ»šåŠ¨åˆ°é¡¶éƒ¨
  window.scrollTo(0, 0);
}

// ============================================
// ç™»å½•é€»è¾‘
// ============================================
async function handleLogin() {
  const name = document.getElementById('login-name').value.trim();
  const dept = document.getElementById('login-dept').value;
  const errorEl = document.getElementById('login-error');
  errorEl.classList.add('hidden');

  if (!name) { showLoginError('è¯·è¾“å…¥å§“å'); return; }
  if (!dept) { showLoginError('è¯·é€‰æ‹©éƒ¨é—¨'); return; }

  const btn = document.getElementById('btn-login');
  btn.disabled = true;
  btn.textContent = 'ç™»å½•ä¸­...';

  try {
    // å°è¯•æŸ¥æ‰¾å·²æœ‰ç”¨æˆ·
    let { data: profile, error } = await supabase
      .from('profiles')
      .select('*')
      .eq('name', name)
      .eq('department', dept)
      .maybeSingle();

    if (error) throw error;

    // å¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»º
    if (!profile) {
      const { data: newProfile, error: insertError } = await supabase
        .from('profiles')
        .insert({ name, department: dept })
        .select()
        .single();
      if (insertError) throw insertError;
      profile = newProfile;
    }

    currentUser = profile;
    localStorage.setItem('quiz_user', JSON.stringify(profile));
    document.getElementById('user-badge').textContent = `${profile.name} Â· ${profile.department}`;
    navigateTo('list');
  } catch (err) {
    console.error('ç™»å½•å¤±è´¥:', err);
    showLoginError('ç™»å½•å¤±è´¥: ' + (err.message || err.code || JSON.stringify(err)));
  } finally {
    btn.disabled = false;
    btn.textContent = 'è¿›å…¥ç³»ç»Ÿ';
  }
}

function showLoginError(msg) {
  const el = document.getElementById('login-error');
  el.textContent = msg;
  el.classList.remove('hidden');
}

function handleLogout() {
  localStorage.removeItem('quiz_user');
  currentUser = null;
  navigateTo('login');
}

// é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
function checkAuth() {
  const saved = localStorage.getItem('quiz_user');
  if (saved) {
    try {
      currentUser = JSON.parse(saved);
      document.getElementById('user-badge').textContent = `${currentUser.name} Â· ${currentUser.department}`;
      navigateTo('list');
    } catch { navigateTo('login'); }
  } else {
    navigateTo('login');
  }
}

// ============================================
// è€ƒæ ¸åˆ—è¡¨
// ============================================
async function loadQuizList() {
  const listEl = document.getElementById('quiz-list');
  const emptyEl = document.getElementById('quiz-list-empty');
  const loadingEl = document.getElementById('quiz-list-loading');

  listEl.innerHTML = '';
  emptyEl.classList.add('hidden');
  loadingEl.classList.remove('hidden');

  try {
    // è·å–æ‰€æœ‰æ¿€æ´»çš„è€ƒæ ¸
    const { data: quizzes, error: qErr } = await supabase
      .from('quizzes')
      .select('*')
      .eq('is_active', true)
      .order('created_at', { ascending: false });
    if (qErr) throw qErr;

    if (!quizzes || quizzes.length === 0) {
      loadingEl.classList.add('hidden');
      emptyEl.classList.remove('hidden');
      return;
    }

    // è·å–æ¯ä¸ªè€ƒæ ¸çš„é¢˜ç›®æ•°
    const quizIds = quizzes.map(q => q.id);
    const { data: questions, error: questErr } = await supabase
      .from('questions')
      .select('id, quiz_id')
      .in('quiz_id', quizIds);
    if (questErr) throw questErr;

    // ç»Ÿè®¡æ¯ä¸ªè€ƒæ ¸çš„é¢˜ç›®æ•°
    const questionCounts = {};
    (questions || []).forEach(q => {
      questionCounts[q.quiz_id] = (questionCounts[q.quiz_id] || 0) + 1;
    });

    // è·å–å½“å‰ç”¨æˆ·çš„æœ€é«˜åˆ†
    const { data: attempts, error: attErr } = await supabase
      .from('attempts')
      .select('quiz_id, score')
      .eq('user_id', currentUser.id);
    if (attErr) throw attErr;

    const bestScores = {};
    (attempts || []).forEach(a => {
      if (!bestScores[a.quiz_id] || a.score > bestScores[a.quiz_id]) {
        bestScores[a.quiz_id] = a.score;
      }
    });

    // è·å–æ‰€æœ‰è€ƒæ ¸çš„æ’è¡Œæ¦œæ•°æ®ï¼ˆå…¨éƒ¨ attemptsï¼‰
    const { data: allAttempts, error: allAttErr } = await supabase
      .from('attempts')
      .select('quiz_id, score, user_id')
      .in('quiz_id', quizIds);
    if (allAttErr) throw allAttErr;

    // è·å–æ‰€æœ‰ç›¸å…³ç”¨æˆ·ä¿¡æ¯ç”¨äºæ’è¡Œæ¦œ
    const allUserIds = [...new Set((allAttempts || []).map(a => a.user_id))];
    let userMap = {};
    if (allUserIds.length > 0) {
      const { data: users } = await supabase
        .from('profiles')
        .select('id, name, department')
        .in('id', allUserIds);
      (users || []).forEach(u => { userMap[u.id] = u; });
    }

    // è®¡ç®—æ¯ä¸ªè€ƒæ ¸æ¯ä¸ªç”¨æˆ·çš„æœ€é«˜åˆ†
    const leaderboards = {};
    (allAttempts || []).forEach(a => {
      if (!leaderboards[a.quiz_id]) leaderboards[a.quiz_id] = {};
      if (!leaderboards[a.quiz_id][a.user_id] || a.score > leaderboards[a.quiz_id][a.user_id]) {
        leaderboards[a.quiz_id][a.user_id] = a.score;
      }
    });

    // æ¸²æŸ“
    loadingEl.classList.add('hidden');
    quizzes.forEach(quiz => {
      const qCount = questionCounts[quiz.id] || 0;
      const best = bestScores[quiz.id];
      const passed = best !== undefined && best >= quiz.passing_score;

      // æ’è¡Œæ¦œ TOP 10
      const lb = leaderboards[quiz.id] || {};
      const top10 = Object.entries(lb)
        .map(([uid, score]) => ({ user: userMap[uid], score }))
        .filter(x => x.user)
        .sort((a, b) => b.score - a.score)
        .slice(0, 10);

      const card = document.createElement('div');
      card.className = 'bg-white rounded-2xl shadow-sm border overflow-hidden';
      card.innerHTML = `
        <div class="p-5">
          <div class="flex items-start justify-between mb-3">
            <div class="flex-1 min-w-0">
              <h3 class="font-bold text-gray-900 text-lg truncate">${escHtml(quiz.title)}</h3>
              <div class="flex flex-wrap gap-x-4 gap-y-1 mt-1.5 text-sm text-gray-500">
                ${quiz.date ? `<span>ğŸ“… ${quiz.date}</span>` : ''}
                ${quiz.trainer ? `<span>ğŸ‘¨â€ğŸ« ${escHtml(quiz.trainer)}</span>` : ''}
                <span>ğŸ“ ${qCount} é¢˜</span>
                <span>ğŸ¯ åˆæ ¼çº¿ ${quiz.passing_score} åˆ†</span>
              </div>
            </div>
            ${best !== undefined ? `
              <div class="ml-3 text-center flex-shrink-0">
                <div class="text-2xl font-bold ${passed ? 'text-green-600' : 'text-red-500'}">${best}</div>
                <div class="text-xs ${passed ? 'text-green-600' : 'text-red-500'}">${passed ? 'å·²é€šè¿‡' : 'æœªé€šè¿‡'}</div>
              </div>
            ` : ''}
          </div>
          ${quiz.description ? `<p class="text-sm text-gray-500 mb-3 line-clamp-2">${escHtml(quiz.description)}</p>` : ''}
          <div class="flex gap-2">
            <button onclick="navigateTo('quiz', '${quiz.id}')"
              class="flex-1 py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl text-sm font-medium transition active:scale-[0.98]">
              ${best !== undefined ? 'å†æ¬¡æŒ‘æˆ˜' : 'å¼€å§‹ç­”é¢˜'}
            </button>
            ${top10.length > 0 ? `
              <button onclick="toggleLeaderboard('${quiz.id}')"
                class="px-4 py-2.5 border-2 border-indigo-600 text-indigo-600 rounded-xl text-sm font-medium hover:bg-indigo-50 transition">
                ğŸ† æ’è¡Œæ¦œ
              </button>
            ` : ''}
          </div>
        </div>
        ${top10.length > 0 ? `
          <div id="lb-${quiz.id}" class="leaderboard-panel border-t bg-gray-50">
            <div class="p-4 space-y-2">
              <h4 class="text-sm font-bold text-gray-700 mb-2">ğŸ† TOP 10 æ’è¡Œæ¦œ</h4>
              ${top10.map((item, i) => `
                <div class="flex items-center gap-3 py-1.5">
                  <span class="w-6 text-center font-bold ${i < 3 ? 'text-indigo-600' : 'text-gray-400'}">${i === 0 ? 'ğŸ¥‡' : i === 1 ? 'ğŸ¥ˆ' : i === 2 ? 'ğŸ¥‰' : (i+1)}</span>
                  <span class="flex-1 text-sm text-gray-700">${escHtml(item.user.name)}</span>
                  <span class="text-xs text-gray-400">${escHtml(item.user.department)}</span>
                  <span class="font-bold text-sm ${item.score >= quiz.passing_score ? 'text-green-600' : 'text-red-500'}">${item.score}åˆ†</span>
                </div>
              `).join('')}
            </div>
          </div>
        ` : ''}
      `;
      listEl.appendChild(card);
    });
  } catch (err) {
    console.error('åŠ è½½è€ƒæ ¸åˆ—è¡¨å¤±è´¥:', err);
    loadingEl.classList.add('hidden');
    listEl.innerHTML = `<div class="text-center py-10 text-red-500">åŠ è½½å¤±è´¥: ${escHtml(err.message || 'ç½‘ç»œé”™è¯¯')}<br><button onclick="loadQuizList()" class="mt-3 text-indigo-600 underline">é‡è¯•</button></div>`;
  }
}

function toggleLeaderboard(quizId) {
  const panel = document.getElementById('lb-' + quizId);
  if (panel) panel.classList.toggle('open');
}

// ============================================
// ç­”é¢˜é¡µ
// ============================================
async function loadQuiz(quizId) {
  const container = document.getElementById('questions-container');
  container.innerHTML = '<div class="text-center py-20 text-gray-400"><div class="inline-block w-8 h-8 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin"></div><p class="mt-3">åŠ è½½é¢˜ç›®ä¸­...</p></div>';
  userAnswers = {};

  try {
    // è·å–è€ƒæ ¸ä¿¡æ¯
    const { data: quiz, error: qErr } = await supabase
      .from('quizzes')
      .select('*')
      .eq('id', quizId)
      .single();
    if (qErr) throw qErr;
    currentQuiz = quiz;

    // è·å–é¢˜ç›®åˆ—è¡¨
    const { data: questions, error: questErr } = await supabase
      .from('questions')
      .select('*')
      .eq('quiz_id', quizId)
      .order('order_num', { ascending: true });
    if (questErr) throw questErr;
    currentQuestions = questions || [];

    if (currentQuestions.length === 0) {
      container.innerHTML = '<div class="text-center py-20 text-gray-400">è¯¥è€ƒæ ¸æš‚æ— é¢˜ç›®</div>';
      return;
    }

    document.getElementById('quiz-title-bar').textContent = quiz.title;
    updateProgress();
    renderQuestions();
  } catch (err) {
    console.error('åŠ è½½é¢˜ç›®å¤±è´¥:', err);
    container.innerHTML = `<div class="text-center py-10 text-red-500">åŠ è½½å¤±è´¥: ${escHtml(err.message)}<br><button onclick="navigateTo('list')" class="mt-3 text-indigo-600 underline">è¿”å›åˆ—è¡¨</button></div>`;
  }
}

function renderQuestions() {
  const container = document.getElementById('questions-container');
  container.innerHTML = '';

  currentQuestions.forEach((q, idx) => {
    const div = document.createElement('div');
    div.className = 'bg-white rounded-2xl shadow-sm border p-5';
    div.id = 'q-' + q.id;

    // é¢˜å‹æ ‡ç­¾
    const typeLabels = { single: 'å•é€‰', multiple: 'å¤šé€‰', truefalse: 'åˆ¤æ–­', fill: 'å¡«ç©º' };
    const typeColors = { single: 'bg-blue-100 text-blue-700', multiple: 'bg-purple-100 text-purple-700', truefalse: 'bg-green-100 text-green-700', fill: 'bg-orange-100 text-orange-700' };

    let optionsHtml = '';
    const options = q.options ? (typeof q.options === 'string' ? JSON.parse(q.options) : q.options) : [];

    switch(q.type) {
      case 'single':
        optionsHtml = options.map((opt, i) => `
          <label class="flex items-start gap-3 p-3 rounded-xl border-2 border-transparent hover:bg-gray-50 cursor-pointer transition option-item" data-qid="${q.id}" data-idx="${i}">
            <input type="radio" name="q_${q.id}" value="${i}" onchange="setAnswer('${q.id}', ${i}, 'single')"
              class="mt-0.5 w-5 h-5 text-indigo-600 focus:ring-indigo-500">
            <span class="text-gray-700">${escHtml(opt)}</span>
          </label>
        `).join('');
        break;
      case 'multiple':
        optionsHtml = options.map((opt, i) => `
          <label class="flex items-start gap-3 p-3 rounded-xl border-2 border-transparent hover:bg-gray-50 cursor-pointer transition option-item" data-qid="${q.id}" data-idx="${i}">
            <input type="checkbox" value="${i}" onchange="setMultiAnswer('${q.id}')"
              class="mt-0.5 w-5 h-5 text-indigo-600 rounded focus:ring-indigo-500" data-multi="${q.id}">
            <span class="text-gray-700">${escHtml(opt)}</span>
          </label>
        `).join('');
        break;
      case 'truefalse':
        optionsHtml = `
          <div class="flex gap-3">
            <button onclick="setAnswer('${q.id}', true, 'truefalse')" id="tf-${q.id}-true"
              class="flex-1 py-4 rounded-xl border-2 border-gray-200 text-lg font-medium hover:border-indigo-400 transition tf-btn" data-qid="${q.id}">
              âœ… æ­£ç¡®
            </button>
            <button onclick="setAnswer('${q.id}', false, 'truefalse')" id="tf-${q.id}-false"
              class="flex-1 py-4 rounded-xl border-2 border-gray-200 text-lg font-medium hover:border-indigo-400 transition tf-btn" data-qid="${q.id}">
              âŒ é”™è¯¯
            </button>
          </div>
        `;
        break;
      case 'fill':
        optionsHtml = `
          <input type="text" placeholder="è¯·è¾“å…¥ç­”æ¡ˆ" oninput="setAnswer('${q.id}', this.value, 'fill')"
            class="w-full px-4 py-3 border-2 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition" data-fill="${q.id}">
        `;
        break;
    }

    div.innerHTML = `
      <div class="flex items-center gap-2 mb-3">
        <span class="text-sm font-medium text-gray-400">${idx + 1}/${currentQuestions.length}</span>
        <span class="text-xs px-2 py-0.5 rounded-full ${typeColors[q.type] || 'bg-gray-100 text-gray-600'}">${typeLabels[q.type] || q.type}</span>
      </div>
      <h3 class="text-base font-medium text-gray-900 mb-4 leading-relaxed">${escHtml(q.question)}</h3>
      <div class="space-y-2">${optionsHtml}</div>
    `;
    container.appendChild(div);
  });
}

// è®¾ç½®ç­”æ¡ˆï¼ˆå•é€‰/åˆ¤æ–­/å¡«ç©ºï¼‰
function setAnswer(qid, value, type) {
  userAnswers[qid] = value;
  updateProgress();

  if (type === 'truefalse') {
    // é«˜äº®é€‰ä¸­çš„æŒ‰é’®
    document.querySelectorAll(`.tf-btn[data-qid="${qid}"]`).forEach(btn => {
      btn.classList.remove('border-indigo-600', 'bg-indigo-50', 'text-indigo-700');
      btn.classList.add('border-gray-200');
    });
    const selected = document.getElementById(`tf-${qid}-${value}`);
    if (selected) {
      selected.classList.remove('border-gray-200');
      selected.classList.add('border-indigo-600', 'bg-indigo-50', 'text-indigo-700');
    }
  }

  if (type === 'single') {
    // é«˜äº®é€‰ä¸­çš„é€‰é¡¹
    document.querySelectorAll(`.option-item[data-qid="${qid}"]`).forEach(el => {
      el.classList.remove('border-indigo-600', 'bg-indigo-50');
      el.classList.add('border-transparent');
    });
    const selected = document.querySelector(`.option-item[data-qid="${qid}"][data-idx="${value}"]`);
    if (selected) {
      selected.classList.remove('border-transparent');
      selected.classList.add('border-indigo-600', 'bg-indigo-50');
    }
  }
}

// è®¾ç½®å¤šé€‰ç­”æ¡ˆ
function setMultiAnswer(qid) {
  const checks = document.querySelectorAll(`input[data-multi="${qid}"]:checked`);
  const values = Array.from(checks).map(c => parseInt(c.value));
  if (values.length > 0) {
    userAnswers[qid] = values;
  } else {
    delete userAnswers[qid];
  }
  updateProgress();

  // é«˜äº®å·²é€‰é€‰é¡¹
  document.querySelectorAll(`.option-item[data-qid="${qid}"]`).forEach(el => {
    const idx = parseInt(el.dataset.idx);
    if (values.includes(idx)) {
      el.classList.remove('border-transparent');
      el.classList.add('border-indigo-600', 'bg-indigo-50');
    } else {
      el.classList.remove('border-indigo-600', 'bg-indigo-50');
      el.classList.add('border-transparent');
    }
  });
}

// æ›´æ–°è¿›åº¦
function updateProgress() {
  const total = currentQuestions.length;
  const answered = Object.keys(userAnswers).filter(k => {
    const v = userAnswers[k];
    return v !== undefined && v !== '' && !(Array.isArray(v) && v.length === 0);
  }).length;
  const pct = total > 0 ? Math.round((answered / total) * 100) : 0;
  document.getElementById('quiz-progress-bar').style.width = pct + '%';
  document.getElementById('quiz-progress-text').textContent = `${answered}/${total}`;
}

// é€€å‡ºç¡®è®¤
function confirmExit() {
  const answered = Object.keys(userAnswers).length;
  if (answered > 0) {
    if (confirm('ç¡®å®šè¦é€€å‡ºå—ï¼Ÿå·²ç­”çš„å†…å®¹å°†ä¸ä¼šä¿å­˜ã€‚')) {
      navigateTo('list');
    }
  } else {
    navigateTo('list');
  }
}

// ============================================
// æäº¤åˆ¤åˆ†
// ============================================
async function handleSubmit() {
  const total = currentQuestions.length;
  const answered = Object.keys(userAnswers).filter(k => {
    const v = userAnswers[k];
    return v !== undefined && v !== '' && !(Array.isArray(v) && v.length === 0);
  }).length;

  if (answered < total) {
    if (!confirm(`ä½ è¿˜æœ‰ ${total - answered} é¢˜æœªä½œç­”ï¼Œç¡®å®šè¦æäº¤å—ï¼Ÿ`)) return;
  }

  const btn = document.getElementById('btn-submit');
  btn.disabled = true;
  btn.textContent = 'æäº¤ä¸­...';

  try {
    // åˆ¤åˆ†
    let correctCount = 0;
    const responseRecords = [];

    currentQuestions.forEach(q => {
      const userAns = userAnswers[q.id];
      const correctAns = typeof q.answer === 'string' ? JSON.parse(q.answer) : q.answer;
      let isCorrect = false;

      if (userAns !== undefined && userAns !== '') {
        switch(q.type) {
          case 'single':
            isCorrect = Number(userAns) === Number(correctAns);
            break;
          case 'multiple':
            if (Array.isArray(userAns) && Array.isArray(correctAns)) {
              const sorted1 = [...userAns].map(Number).sort();
              const sorted2 = [...correctAns].map(Number).sort();
              isCorrect = JSON.stringify(sorted1) === JSON.stringify(sorted2);
            }
            break;
          case 'truefalse':
            isCorrect = userAns === correctAns;
            break;
          case 'fill':
            isCorrect = String(userAns).trim().toLowerCase() === String(correctAns).trim().toLowerCase();
            break;
        }
      }

      if (isCorrect) correctCount++;

      responseRecords.push({
        question_id: q.id,
        user_answer: userAns !== undefined ? userAns : null,
        is_correct: isCorrect
      });
    });

    const score = total > 0 ? Math.round((correctCount / total) * 100) : 0;

    // å­˜å…¥ attempts
    const { data: attempt, error: attErr } = await supabase
      .from('attempts')
      .insert({
        user_id: currentUser.id,
        quiz_id: currentQuiz.id,
        score: score,
        correct_count: correctCount,
        total: total
      })
      .select()
      .single();
    if (attErr) throw attErr;

    // å­˜å…¥ responses
    const responsesWithAttempt = responseRecords.map(r => ({
      ...r,
      attempt_id: attempt.id
    }));
    const { error: respErr } = await supabase
      .from('responses')
      .insert(responsesWithAttempt);
    if (respErr) throw respErr;

    // è·³è½¬ç»“æœé¡µ
    navigateTo('result', {
      score,
      correctCount,
      total,
      passingScore: currentQuiz.passing_score,
      questions: currentQuestions,
      userAnswers,
      responses: responseRecords
    });
  } catch (err) {
    console.error('æäº¤å¤±è´¥:', err);
    alert('æäº¤å¤±è´¥: ' + (err.message || 'ç½‘ç»œé”™è¯¯'));
  } finally {
    btn.disabled = false;
    btn.textContent = 'æäº¤ç­”å·';
  }
}

// ============================================
// ç»“æœé¡µ
// ============================================
function showResult(data) {
  const { score, correctCount, total, passingScore, questions, userAnswers: answers, responses } = data;
  const passed = score >= passingScore;

  // åˆ†æ•°ç¯
  const circle = document.getElementById('score-circle');
  const offset = 283 - (283 * score / 100);
  circle.style.stroke = passed ? '#059669' : '#ef4444';
  circle.style.strokeDashoffset = offset;

  document.getElementById('score-number').textContent = score;
  document.getElementById('score-number').className = `text-4xl font-bold ${passed ? 'text-green-600' : 'text-red-500'}`;

  document.getElementById('result-status').textContent = passed ? 'ğŸ‰ æ­å–œé€šè¿‡ï¼' : 'ğŸ˜” æœªé€šè¿‡';
  document.getElementById('result-status').className = `mt-4 text-xl font-bold ${passed ? 'text-green-600' : 'text-red-500'}`;

  document.getElementById('result-stats').textContent = `ç­”å¯¹ ${correctCount}/${total} é¢˜ Â· åˆæ ¼çº¿ ${passingScore} åˆ†`;

  // è§£æå†…å®¹
  const analysisContent = document.getElementById('analysis-content');
  analysisContent.innerHTML = '';
  document.getElementById('analysis-panel').classList.remove('open');
  document.getElementById('btn-analysis').textContent = 'æŸ¥çœ‹è§£æ';

  questions.forEach((q, idx) => {
    const resp = responses[idx];
    const correctAns = typeof q.answer === 'string' ? JSON.parse(q.answer) : q.answer;
    const options = q.options ? (typeof q.options === 'string' ? JSON.parse(q.options) : q.options) : [];
    const typeLabels = { single: 'å•é€‰', multiple: 'å¤šé€‰', truefalse: 'åˆ¤æ–­', fill: 'å¡«ç©º' };

    // æ ¼å¼åŒ–æ­£ç¡®ç­”æ¡ˆæ˜¾ç¤º
    let correctDisplay = '';
    let userDisplay = '';

    switch(q.type) {
      case 'single':
        correctDisplay = options[Number(correctAns)] || correctAns;
        userDisplay = answers[q.id] !== undefined ? (options[Number(answers[q.id])] || 'æœªä½œç­”') : 'æœªä½œç­”';
        break;
      case 'multiple':
        correctDisplay = (Array.isArray(correctAns) ? correctAns : []).map(i => options[Number(i)]).filter(Boolean).join('ã€');
        userDisplay = answers[q.id] ? (Array.isArray(answers[q.id]) ? answers[q.id].map(i => options[Number(i)]).filter(Boolean).join('ã€') : 'æœªä½œç­”') : 'æœªä½œç­”';
        break;
      case 'truefalse':
        correctDisplay = correctAns ? 'æ­£ç¡® âœ…' : 'é”™è¯¯ âŒ';
        userDisplay = answers[q.id] !== undefined ? (answers[q.id] ? 'æ­£ç¡® âœ…' : 'é”™è¯¯ âŒ') : 'æœªä½œç­”';
        break;
      case 'fill':
        correctDisplay = String(correctAns);
        userDisplay = answers[q.id] || 'æœªä½œç­”';
        break;
    }

    const div = document.createElement('div');
    div.className = `p-4 rounded-xl border-2 ${resp.is_correct ? 'border-green-200 bg-green-50' : 'border-red-200 bg-red-50'}`;
    div.innerHTML = `
      <div class="flex items-center gap-2 mb-2">
        <span class="${resp.is_correct ? 'text-green-600' : 'text-red-500'} font-bold">${resp.is_correct ? 'âœ“' : 'âœ—'}</span>
        <span class="text-sm text-gray-500">${idx + 1}. [${typeLabels[q.type]}]</span>
      </div>
      <p class="text-sm font-medium text-gray-900 mb-2">${escHtml(q.question)}</p>
      <div class="text-sm space-y-1">
        <p><span class="text-gray-500">ä½ çš„ç­”æ¡ˆï¼š</span><span class="${resp.is_correct ? 'text-green-700' : 'text-red-600'}">${escHtml(userDisplay)}</span></p>
        ${!resp.is_correct ? `<p><span class="text-gray-500">æ­£ç¡®ç­”æ¡ˆï¼š</span><span class="text-green-700">${escHtml(correctDisplay)}</span></p>` : ''}
        ${q.explanation ? `<p class="mt-2 text-gray-600 bg-white/60 rounded-lg p-2 text-xs leading-relaxed">ğŸ’¡ ${escHtml(q.explanation)}</p>` : ''}
      </div>
    `;
    analysisContent.appendChild(div);
  });
}

function toggleAnalysis() {
  const panel = document.getElementById('analysis-panel');
  const btn = document.getElementById('btn-analysis');
  if (panel.classList.contains('open')) {
    panel.classList.remove('open');
    btn.textContent = 'æŸ¥çœ‹è§£æ';
  } else {
    panel.classList.add('open');
    btn.textContent = 'æ”¶èµ·è§£æ';
  }
}

// ============================================
// å·¥å…·å‡½æ•°
// ============================================
function escHtml(str) {
  if (!str) return '';
  const div = document.createElement('div');
  div.textContent = String(str);
  return div.innerHTML;
}

// ============================================
// å¯åŠ¨
// ============================================
document.addEventListener('DOMContentLoaded', checkAuth);
</script>
</body>
</html>
