<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åŸ¹è®­è€ƒæ ¸ç³»ç»Ÿ</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+SC:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
:root {
  --olive: #5c6b50;
  --olive-dark: #4a5740;
  --olive-light: #e8ebe5;
  --olive-bg: #f0f2ed;
  --cream: #fdfdf8;
  --success: #3d8b37;
  --danger: #c53030;
  --warning: #b7791f;
  --radius: 12px;
}
* { margin:0; padding:0; box-sizing:border-box; }
body {
  font-family: 'Inter', 'Noto Sans SC', -apple-system, sans-serif;
  background: var(--cream);
  color: #18181b;
  line-height: 1.6;
  min-height: 100vh;
}

/* Pages */
.page { display:none; opacity:0; transition: opacity .3s ease; }
.page.active { display:block; opacity:1; }

/* Container */
.container { max-width: 720px; margin: 0 auto; padding: 0 20px; }

/* Nav bar */
.navbar {
  position: sticky; top:0; z-index:100;
  background: rgba(253,253,248,.92);
  backdrop-filter: blur(10px);
  border-bottom: 1px solid #e4e4e7;
  padding: 14px 20px;
}
.navbar-inner { max-width:720px; margin:0 auto; display:flex; align-items:center; justify-content:space-between; }
.navbar .brand { font-weight:600; font-size:15px; color:#18181b; display:flex; align-items:center; gap:8px; }
.navbar .brand svg { width:28px; height:28px; }
.navbar .user-info { font-size:13px; color:#71717a; display:flex; align-items:center; gap:12px; }
.navbar .logout { color:var(--olive); font-weight:500; cursor:pointer; border:none; background:none; font-size:13px; }
.navbar .logout:hover { color:var(--olive-dark); }

/* Buttons */
.btn {
  display:inline-flex; align-items:center; justify-content:center;
  padding:12px 24px; border:none; border-radius:8px;
  font-size:15px; font-weight:500; cursor:pointer; transition:all .2s;
  font-family:inherit;
}
.btn-primary { background:var(--olive); color:#fff; width:100%; }
.btn-primary:hover { background:var(--olive-dark); }
.btn-primary:disabled { opacity:.5; cursor:not-allowed; }
.btn-outline { background:#fff; color:var(--olive); border:1.5px solid var(--olive); }
.btn-outline:hover { background:var(--olive-light); }
.btn-sm { padding:8px 16px; font-size:13px; }

/* Cards */
.card {
  background:#fff; border-radius:var(--radius);
  border:1px solid #e4e4e7; padding:24px;
  transition: all .2s;
}
.card-hover:hover { border-color:var(--olive); box-shadow:0 4px 12px rgba(92,107,80,.1); transform:translateY(-1px); }

/* Forms */
.form-label { display:block; font-size:13px; font-weight:500; color:#52525b; margin-bottom:6px; }
.form-input, .form-select {
  width:100%; padding:12px 16px;
  border:1.5px solid #e4e4e7; border-radius:8px;
  font-size:15px; font-family:inherit; background:#fff;
  transition: border-color .2s;
}
.form-input:focus, .form-select:focus {
  outline:none; border-color:var(--olive);
  box-shadow:0 0 0 3px rgba(92,107,80,.12);
}

/* Badge */
.badge {
  display:inline-flex; align-items:center; gap:4px;
  padding:4px 10px; border-radius:20px;
  font-size:12px; font-weight:500;
}
.badge-olive { background:var(--olive-light); color:var(--olive); }
.badge-success { background:#dcfce7; color:#166534; }
.badge-danger { background:#fef2f2; color:#991b1b; }

/* Progress */
.progress-track { width:100%; height:6px; background:#e4e4e7; border-radius:3px; overflow:hidden; }
.progress-fill { height:100%; background:var(--olive); border-radius:3px; transition:width .3s; }

/* Options */
.option-item {
  display:flex; align-items:flex-start; gap:12px;
  padding:14px 16px; border:1.5px solid #e4e4e7; border-radius:10px;
  cursor:pointer; transition:all .15s; background:#fff;
}
.option-item:hover { border-color:#a1a1aa; background:#fafafa; }
.option-item.selected { border-color:var(--olive); background:var(--olive-light); }
.option-item.correct { border-color:var(--success); background:#f0fdf4; }
.option-item.wrong { border-color:var(--danger); background:#fef2f2; }
.option-item input[type="radio"], .option-item input[type="checkbox"] {
  accent-color:var(--olive); margin-top:2px; width:18px; height:18px; flex-shrink:0;
}

/* TF Buttons */
.tf-btn {
  flex:1; padding:16px; border:1.5px solid #e4e4e7; border-radius:10px;
  background:#fff; font-size:16px; font-weight:500; cursor:pointer;
  transition:all .15s; font-family:inherit;
}
.tf-btn:hover { border-color:#a1a1aa; }
.tf-btn.selected { border-color:var(--olive); background:var(--olive-light); color:var(--olive-dark); }

/* Explanation */
.explanation {
  margin-top:12px; padding:12px 16px;
  background:#fffbeb; border-left:3px solid var(--warning);
  border-radius:0 8px 8px 0; font-size:13px; color:#92400e;
}

/* Source */
.source-panel {
  margin-top:8px; padding:12px 16px;
  background:var(--olive-bg); border-left:3px solid var(--olive);
  border-radius:0 8px 8px 0; font-size:13px; color:var(--olive-dark);
}
.source-panel summary { cursor:pointer; font-weight:500; }
.source-panel .content { margin-top:8px; white-space:pre-wrap; line-height:1.7; color:#52525b; max-height:200px; overflow-y:auto; }

/* Score ring */
.score-ring-wrap { position:relative; display:inline-block; }
.score-ring-wrap .center { position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; }
@keyframes ringDraw { from { stroke-dashoffset: 283; } }
.ring-anim { animation: ringDraw 1s ease-out; }

/* Leaderboard */
.lb-row { display:flex; align-items:center; padding:10px 0; border-bottom:1px solid #f4f4f5; }
.lb-row:last-child { border-bottom:none; }
.lb-rank { width:28px; text-align:center; font-weight:700; font-size:14px; margin-right:12px; flex-shrink:0; }

/* Analysis toggle */
.analysis-wrap { max-height:0; overflow:hidden; transition:max-height .5s ease; }
.analysis-wrap.open { max-height:99999px; }

/* Error */
.error-msg { color:var(--danger); font-size:13px; text-align:center; margin-top:12px; }

/* Responsive */
@media(max-width:640px) {
  .container { padding:0 16px; }
  .card { padding:16px; }
}
  </style>
</head>
<body>

<!-- ===== LOGIN ===== -->
<div id="page-login" class="page active">
  <div style="min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;">
    <div style="width:100%;max-width:380px;">
      <div style="text-align:center;margin-bottom:32px;">
        <div style="display:inline-flex;align-items:center;justify-content:center;width:56px;height:56px;background:var(--olive);border-radius:14px;margin-bottom:16px;">
          <svg width="28" height="28" viewBox="0 0 32 32" fill="none"><rect width="32" height="32" rx="8" fill="none"/><path d="M8 16L14 10L20 16L14 22L8 16Z" fill="white"/><path d="M14 16L20 10L26 16L20 22L14 16Z" fill="white" fill-opacity="0.6"/></svg>
        </div>
        <h1 style="font-size:24px;font-weight:600;color:#18181b;">åŸ¹è®­è€ƒæ ¸ç³»ç»Ÿ</h1>
        <p style="font-size:14px;color:#71717a;margin-top:4px;">è¯·è¾“å…¥ä¿¡æ¯å¼€å§‹è€ƒæ ¸</p>
      </div>
      <div class="card">
        <div style="margin-bottom:16px;">
          <label class="form-label">å§“å</label>
          <input id="login-name" type="text" class="form-input" placeholder="è¯·è¾“å…¥ä½ çš„å§“å">
        </div>
        <div style="margin-bottom:20px;">
          <label class="form-label">éƒ¨é—¨</label>
          <select id="login-dept" class="form-select">
            <option value="">è¯·é€‰æ‹©éƒ¨é—¨</option>
            <option>äº§å“éƒ¨</option><option>ç ”å‘éƒ¨</option><option>å”®å‰éƒ¨</option>
            <option>é”€å”®éƒ¨</option><option>äº¤ä»˜éƒ¨</option><option>å®¢æˆ·æˆåŠŸéƒ¨</option>
            <option>å¸‚åœºéƒ¨</option><option>æ³•åŠ¡éƒ¨</option><option>è´¢åŠ¡éƒ¨</option><option>å…¶ä»–</option>
          </select>
        </div>
        <button id="btn-login" class="btn btn-primary">è¿›å…¥ç³»ç»Ÿ</button>
        <div id="login-error" class="error-msg" style="display:none;"></div>
      </div>
    </div>
  </div>
</div>

<!-- ===== QUIZ LIST ===== -->
<div id="page-list" class="page">
  <div class="navbar">
    <div class="navbar-inner">
      <div class="brand">
        <svg viewBox="0 0 32 32" fill="none"><rect width="32" height="32" rx="8" fill="#5c6b50"/><path d="M8 16L14 10L20 16L14 22L8 16Z" fill="white"/><path d="M14 16L20 10L26 16L20 22L14 16Z" fill="white" fill-opacity="0.6"/></svg>
        åŸ¹è®­è€ƒæ ¸
      </div>
      <div class="user-info">
        <span id="user-badge"></span>
        <button class="logout" onclick="handleLogout()">é€€å‡º</button>
      </div>
    </div>
  </div>
  <div class="container" style="padding-top:24px;padding-bottom:40px;">
    <div id="quiz-list" style="display:flex;flex-direction:column;gap:16px;"></div>
    <div id="quiz-list-empty" style="display:none;text-align:center;padding:60px 0;color:#a1a1aa;">
      <p style="font-size:15px;">æš‚æ— è€ƒæ ¸</p>
    </div>
    <div id="quiz-list-loading" style="text-align:center;padding:60px 0;color:#a1a1aa;">
      <div style="display:inline-block;width:32px;height:32px;border:3px solid var(--olive-light);border-top-color:var(--olive);border-radius:50%;animation:spin 1s linear infinite;"></div>
      <p style="margin-top:12px;font-size:14px;">åŠ è½½ä¸­...</p>
    </div>
    <style>@keyframes spin{to{transform:rotate(360deg)}}</style>
  </div>
</div>

<!-- ===== QUIZ ===== -->
<div id="page-quiz" class="page">
  <div class="navbar">
    <div class="navbar-inner">
      <button class="btn btn-outline btn-sm" onclick="confirmExit()">â† é€€å‡º</button>
      <span id="quiz-title-bar" style="font-size:14px;font-weight:600;color:#18181b;"></span>
      <span id="quiz-progress-text" style="font-size:13px;color:#71717a;"></span>
    </div>
    <div style="max-width:720px;margin:8px auto 0;">
      <div class="progress-track"><div id="quiz-progress-bar" class="progress-fill" style="width:0%"></div></div>
    </div>
  </div>
  <div class="container" style="padding-top:20px;padding-bottom:40px;">
    <div id="questions-container" style="display:flex;flex-direction:column;gap:20px;"></div>
    <div style="margin-top:24px;">
      <button id="btn-submit" class="btn btn-primary" disabled style="font-size:16px;padding:14px;">æäº¤ç­”å·</button>
    </div>
  </div>
</div>

<!-- ===== RESULT ===== -->
<div id="page-result" class="page">
  <div class="container" style="padding-top:40px;padding-bottom:40px;">
    <div class="card" style="text-align:center;">
      <div class="score-ring-wrap" style="margin-bottom:20px;">
        <svg width="140" height="140" viewBox="0 0 100 100">
          <circle cx="50" cy="50" r="45" fill="none" stroke="#e4e4e7" stroke-width="7"/>
          <circle id="score-circle" cx="50" cy="50" r="45" fill="none" stroke-width="7"
            stroke-linecap="round" transform="rotate(-90 50 50)"
            stroke-dasharray="283" stroke-dashoffset="283" class="ring-anim"/>
        </svg>
        <div class="center">
          <span id="score-number" style="font-size:36px;font-weight:700;"></span>
          <span style="font-size:12px;color:#71717a;">åˆ†</span>
        </div>
      </div>
      <div id="result-status" style="font-size:18px;font-weight:700;margin-bottom:4px;"></div>
      <div id="result-stats" style="font-size:14px;color:#71717a;margin-bottom:24px;"></div>
      <div style="display:flex;gap:12px;">
        <button class="btn btn-outline" style="flex:1;" onclick="navigateTo('list')">è¿”å›åˆ—è¡¨</button>
        <button class="btn btn-primary" style="flex:1;" id="btn-analysis" onclick="toggleAnalysis()">æŸ¥çœ‹è§£æ</button>
      </div>
    </div>
    <div id="analysis-wrap" class="analysis-wrap" style="margin-top:16px;">
      <div id="analysis-content" style="display:flex;flex-direction:column;gap:12px;padding-bottom:20px;"></div>
    </div>
  </div>
</div>

<!-- Supabase SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
<script>
// ============ Init ============
const SUPABASE_URL = 'https://qdipqdysblxckgkcpnqj.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFkaXBxZHlzYmx4Y2tna2NwbnFqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzMDA0NDIsImV4cCI6MjA4NTg3NjQ0Mn0.x0_AQz7tcfvt6s3CdyHfnsBFFDkY32IA1W-7eidxvXs';

let db = null;
let currentUser = null;
let currentQuiz = null;
let currentQuestions = [];
let userAnswers = {};
let lastResultData = null;

function initSupabase() {
  try {
    if (window.supabase && window.supabase.createClient) {
      db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
      return true;
    }
  } catch(e) { console.error(e); }
  return false;
}

// ============ Router ============
function navigateTo(page, data) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  setTimeout(() => {
    const el = document.getElementById('page-' + page);
    if (el) el.classList.add('active');
  }, 20);
  window.scrollTo(0,0);
  if (page === 'list') loadQuizList();
  if (page === 'quiz' && data) loadQuiz(data);
  if (page === 'result' && data) { lastResultData = data; showResult(data); }
}

// ============ Login ============
document.addEventListener('DOMContentLoaded', function() {
  if (!initSupabase()) {
    showLoginErr('Supabase SDK åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢');
    return;
  }
  
  document.getElementById('btn-login').addEventListener('click', handleLogin);
  document.getElementById('login-name').addEventListener('keydown', function(e) { if(e.key==='Enter') handleLogin(); });

  // Auto-login
  const saved = localStorage.getItem('quiz_user');
  if (saved) {
    try {
      currentUser = JSON.parse(saved);
      document.getElementById('user-badge').textContent = currentUser.name + ' Â· ' + currentUser.department;
      navigateTo('list');
    } catch(e) { navigateTo('login'); }
  }
});

async function handleLogin() {
  const name = document.getElementById('login-name').value.trim();
  const dept = document.getElementById('login-dept').value;
  hideLoginErr();

  if (!name) { showLoginErr('è¯·è¾“å…¥å§“å'); return; }
  if (!dept) { showLoginErr('è¯·é€‰æ‹©éƒ¨é—¨'); return; }

  const btn = document.getElementById('btn-login');
  btn.disabled = true;
  btn.textContent = 'ç™»å½•ä¸­...';

  try {
    let { data: profile, error } = await db
      .from('profiles').select('*')
      .eq('name', name).eq('department', dept)
      .maybeSingle();
    if (error) throw error;

    if (!profile) {
      const { data: np, error: ie } = await db
        .from('profiles').insert({ name, department: dept })
        .select().single();
      if (ie) throw ie;
      profile = np;
    }

    currentUser = profile;
    localStorage.setItem('quiz_user', JSON.stringify(profile));
    document.getElementById('user-badge').textContent = profile.name + ' Â· ' + profile.department;
    navigateTo('list');
  } catch(err) {
    showLoginErr('ç™»å½•å¤±è´¥: ' + (err.message || JSON.stringify(err)));
  } finally {
    btn.disabled = false;
    btn.textContent = 'è¿›å…¥ç³»ç»Ÿ';
  }
}

function showLoginErr(msg) {
  const el = document.getElementById('login-error');
  el.textContent = msg; el.style.display = 'block';
}
function hideLoginErr() {
  document.getElementById('login-error').style.display = 'none';
}
function handleLogout() {
  localStorage.removeItem('quiz_user');
  currentUser = null;
  navigateTo('login');
}

// ============ Quiz List ============
async function loadQuizList() {
  const list = document.getElementById('quiz-list');
  const empty = document.getElementById('quiz-list-empty');
  const loading = document.getElementById('quiz-list-loading');
  list.innerHTML = '';
  empty.style.display = 'none';
  loading.style.display = 'block';

  try {
    const { data: quizzes, error: qe } = await db
      .from('quizzes').select('*').eq('is_active', true)
      .order('created_at', { ascending: false });
    if (qe) throw qe;

    if (!quizzes || !quizzes.length) {
      loading.style.display = 'none';
      empty.style.display = 'block';
      return;
    }

    const ids = quizzes.map(q=>q.id);
    const { data: qs } = await db.from('questions').select('id,quiz_id').in('quiz_id', ids);
    const qCounts = {};
    (qs||[]).forEach(q => { qCounts[q.quiz_id] = (qCounts[q.quiz_id]||0)+1; });

    const { data: atts } = await db.from('attempts').select('quiz_id,score').eq('user_id', currentUser.id);
    const bestScores = {};
    (atts||[]).forEach(a => {
      if (!bestScores[a.quiz_id] || a.score > bestScores[a.quiz_id]) bestScores[a.quiz_id] = a.score;
    });

    loading.style.display = 'none';

    quizzes.forEach(quiz => {
      const cnt = qCounts[quiz.id] || 0;
      const best = bestScores[quiz.id];
      const passed = best !== undefined && best >= quiz.passing_score;

      const card = document.createElement('div');
      card.className = 'card card-hover';
      card.style.cursor = 'pointer';
      card.onclick = () => navigateTo('quiz', quiz.id);
      card.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:flex-start;">
          <div style="flex:1;min-width:0;">
            <h3 style="font-size:16px;font-weight:600;margin-bottom:6px;">${esc(quiz.title)}</h3>
            <div style="display:flex;flex-wrap:wrap;gap:8px;font-size:13px;color:#71717a;">
              ${quiz.date ? '<span>ğŸ“… '+quiz.date+'</span>' : ''}
              ${quiz.trainer ? '<span>ğŸ‘¨â€ğŸ« '+esc(quiz.trainer)+'</span>' : ''}
              <span>ğŸ“ ${cnt} é¢˜</span>
              <span>ğŸ¯ ${quiz.passing_score} åˆ†åˆæ ¼</span>
            </div>
            ${quiz.description ? '<p style="font-size:13px;color:#a1a1aa;margin-top:6px;">'+esc(quiz.description)+'</p>' : ''}
          </div>
          ${best !== undefined ? `
            <div style="margin-left:16px;text-align:center;flex-shrink:0;">
              <div style="font-size:28px;font-weight:700;color:${passed?'var(--success)':'var(--danger)'};">${best}</div>
              <span class="badge ${passed?'badge-success':'badge-danger'}">${passed?'å·²é€šè¿‡':'æœªé€šè¿‡'}</span>
            </div>
          ` : '<span class="badge badge-olive">æœªå‚åŠ </span>'}
        </div>
      `;
      list.appendChild(card);
    });
  } catch(err) {
    loading.style.display = 'none';
    list.innerHTML = '<div style="text-align:center;padding:40px;color:var(--danger);">åŠ è½½å¤±è´¥: '+esc(err.message)+'<br><button onclick="loadQuizList()" style="margin-top:8px;color:var(--olive);">é‡è¯•</button></div>';
  }
}

// ============ Quiz ============
async function loadQuiz(quizId) {
  const container = document.getElementById('questions-container');
  container.innerHTML = '<div style="text-align:center;padding:40px;color:#a1a1aa;">åŠ è½½ä¸­...</div>';
  userAnswers = {};
  document.getElementById('btn-submit').disabled = true;

  try {
    const { data: quiz, error: qe } = await db.from('quizzes').select('*').eq('id', quizId).single();
    if (qe) throw qe;
    currentQuiz = quiz;

    const { data: questions, error: qqe } = await db
      .from('questions').select('*').eq('quiz_id', quizId)
      .order('order_num', { ascending: true });
    if (qqe) throw qqe;
    currentQuestions = questions || [];

    document.getElementById('quiz-title-bar').textContent = quiz.title;
    updateProgress();
    renderQuestions();
  } catch(err) {
    container.innerHTML = '<div style="text-align:center;padding:40px;color:var(--danger);">åŠ è½½å¤±è´¥: '+esc(err.message)+'</div>';
  }
}

function renderQuestions() {
  const c = document.getElementById('questions-container');
  c.innerHTML = '';
  const types = { single:'å•é€‰', multiple:'å¤šé€‰', truefalse:'åˆ¤æ–­', fill:'å¡«ç©º' };
  const letters = ['A','B','C','D','E','F'];

  currentQuestions.forEach((q, idx) => {
    const opts = typeof q.options === 'string' ? JSON.parse(q.options) : (q.options || []);
    let optHtml = '';

    if (q.type === 'single') {
      optHtml = opts.map((o,i) => `
        <label class="option-item" data-q="${q.id}" data-i="${i}">
          <input type="radio" name="q_${q.id}" value="${i}" onchange="pickSingle('${q.id}',${i})">
          <span><b style="color:#71717a;margin-right:4px;">${letters[i]}.</b> ${esc(o)}</span>
        </label>`).join('');
    } else if (q.type === 'multiple') {
      optHtml = opts.map((o,i) => `
        <label class="option-item" data-q="${q.id}" data-i="${i}">
          <input type="checkbox" value="${i}" data-mq="${q.id}" onchange="pickMulti('${q.id}')">
          <span><b style="color:#71717a;margin-right:4px;">${letters[i]}.</b> ${esc(o)}</span>
        </label>`).join('');
    } else if (q.type === 'truefalse') {
      optHtml = `<div style="display:flex;gap:12px;">
        <button class="tf-btn" data-q="${q.id}" onclick="pickTF('${q.id}',true,this)">âœ… æ­£ç¡®</button>
        <button class="tf-btn" data-q="${q.id}" onclick="pickTF('${q.id}',false,this)">âŒ é”™è¯¯</button>
      </div>`;
    } else if (q.type === 'fill') {
      optHtml = `<input type="text" class="form-input" placeholder="è¯·è¾“å…¥ç­”æ¡ˆ" oninput="pickFill('${q.id}',this.value)">`;
    }

    const div = document.createElement('div');
    div.className = 'card';
    div.id = 'q-' + q.id;
    div.innerHTML = `
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
        <span style="font-size:13px;color:#a1a1aa;">${idx+1}/${currentQuestions.length}</span>
        <span class="badge badge-olive">${types[q.type]||q.type}</span>
      </div>
      <p style="font-size:15px;font-weight:500;margin-bottom:14px;line-height:1.7;">${esc(q.question)}</p>
      <div style="display:flex;flex-direction:column;gap:8px;">${optHtml}</div>
    `;
    c.appendChild(div);
  });

  document.getElementById('btn-submit').onclick = handleSubmit;
}

function pickSingle(qid, i) {
  userAnswers[qid] = i;
  document.querySelectorAll(`.option-item[data-q="${qid}"]`).forEach(el => {
    el.classList.toggle('selected', parseInt(el.dataset.i) === i);
  });
  updateProgress();
}
function pickMulti(qid) {
  const vals = Array.from(document.querySelectorAll(`input[data-mq="${qid}"]:checked`)).map(c => parseInt(c.value));
  if (vals.length) userAnswers[qid] = vals; else delete userAnswers[qid];
  document.querySelectorAll(`.option-item[data-q="${qid}"]`).forEach(el => {
    el.classList.toggle('selected', vals.includes(parseInt(el.dataset.i)));
  });
  updateProgress();
}
function pickTF(qid, val, btn) {
  userAnswers[qid] = val;
  document.querySelectorAll(`.tf-btn[data-q="${qid}"]`).forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  updateProgress();
}
function pickFill(qid, val) {
  if (val.trim()) userAnswers[qid] = val; else delete userAnswers[qid];
  updateProgress();
}
function updateProgress() {
  const total = currentQuestions.length;
  const done = Object.keys(userAnswers).length;
  document.getElementById('quiz-progress-bar').style.width = (total?done/total*100:0)+'%';
  document.getElementById('quiz-progress-text').textContent = done+'/'+total;
  document.getElementById('btn-submit').disabled = (done === 0);
}
function confirmExit() {
  if (Object.keys(userAnswers).length && !confirm('ç¡®å®šé€€å‡ºï¼Ÿç­”é¢˜è¿›åº¦å°†ä¸¢å¤±ã€‚')) return;
  navigateTo('list');
}

// ============ Submit ============
async function handleSubmit() {
  const total = currentQuestions.length;
  const done = Object.keys(userAnswers).length;
  if (done < total && !confirm(`è¿˜æœ‰ ${total-done} é¢˜æœªç­”ï¼Œç¡®å®šæäº¤ï¼Ÿ`)) return;

  const btn = document.getElementById('btn-submit');
  btn.disabled = true; btn.textContent = 'æäº¤ä¸­...';

  try {
    let correct = 0;
    const resps = [];
    currentQuestions.forEach(q => {
      const ua = userAnswers[q.id];
      const ca = typeof q.answer === 'string' ? JSON.parse(q.answer) : q.answer;
      let ok = false;
      if (ua !== undefined && ua !== '') {
        if (q.type==='single') ok = Number(ua)===Number(ca);
        else if (q.type==='multiple' && Array.isArray(ua) && Array.isArray(ca)) ok = JSON.stringify([...ua].map(Number).sort()) === JSON.stringify([...ca].map(Number).sort());
        else if (q.type==='truefalse') ok = ua === ca;
        else if (q.type==='fill') ok = String(ua).trim().toLowerCase() === String(ca).trim().toLowerCase();
      }
      if (ok) correct++;
      resps.push({ question_id: q.id, user_answer: ua ?? null, is_correct: ok });
    });

    const score = total ? Math.round(correct/total*100) : 0;
    const { data: att, error: ae } = await db.from('attempts')
      .insert({ user_id: currentUser.id, quiz_id: currentQuiz.id, score, correct_count: correct, total })
      .select().single();
    if (ae) throw ae;

    await db.from('responses').insert(resps.map(r => ({ ...r, attempt_id: att.id })));

    navigateTo('result', { score, correct, total, passingScore: currentQuiz.passing_score, questions: currentQuestions, answers: userAnswers, resps });
  } catch(err) {
    alert('æäº¤å¤±è´¥: ' + (err.message || JSON.stringify(err)));
  } finally {
    btn.disabled = false; btn.textContent = 'æäº¤ç­”å·';
  }
}

// ============ Result ============
async function showResult(data) {
  const { score, correct, total, passingScore } = data;
  const passed = score >= passingScore;

  const circle = document.getElementById('score-circle');
  circle.style.stroke = passed ? 'var(--success)' : 'var(--danger)';
  circle.style.strokeDashoffset = 283 - (283 * score / 100);

  document.getElementById('score-number').textContent = score;
  document.getElementById('score-number').style.color = passed ? 'var(--success)' : 'var(--danger)';
  document.getElementById('result-status').textContent = passed ? 'ğŸ‰ æ­å–œé€šè¿‡ï¼' : 'ğŸ˜” æœªé€šè¿‡';
  document.getElementById('result-status').style.color = passed ? 'var(--success)' : 'var(--danger)';
  document.getElementById('result-stats').textContent = `ç­”å¯¹ ${correct}/${total} é¢˜ Â· åˆæ ¼çº¿ ${passingScore} åˆ†`;
  document.getElementById('analysis-wrap').classList.remove('open');
  document.getElementById('btn-analysis').textContent = 'æŸ¥çœ‹è§£æ';

  // Pre-load sources for analysis
  try {
    const qids = data.questions.map(q => q.id);
    const { data: sources } = await db.from('question_sources')
      .select('question_id, training_segments(chapter_num, title, timestamp, content)')
      .in('question_id', qids);
    data._sources = {};
    (sources||[]).forEach(s => {
      if (!data._sources[s.question_id]) data._sources[s.question_id] = [];
      if (s.training_segments) data._sources[s.question_id].push(s.training_segments);
    });
  } catch(e) { data._sources = {}; }

  lastResultData = data;
}

function toggleAnalysis() {
  const wrap = document.getElementById('analysis-wrap');
  const btn = document.getElementById('btn-analysis');
  if (wrap.classList.contains('open')) {
    wrap.classList.remove('open');
    btn.textContent = 'æŸ¥çœ‹è§£æ';
  } else {
    wrap.classList.add('open');
    btn.textContent = 'æ”¶èµ·è§£æ';
    renderAnalysis();
  }
}

function renderAnalysis() {
  const el = document.getElementById('analysis-content');
  if (el.children.length) return;
  const data = lastResultData;
  if (!data) return;
  const letters = ['A','B','C','D','E','F'];

  data.questions.forEach((q, idx) => {
    const resp = data.resps[idx];
    const ca = typeof q.answer === 'string' ? JSON.parse(q.answer) : q.answer;
    const opts = typeof q.options === 'string' ? JSON.parse(q.options) : (q.options||[]);
    const ua = data.answers[q.id];

    let correctStr = '', userStr = '';
    if (q.type==='single') { correctStr=letters[Number(ca)]+'. '+opts[Number(ca)]; userStr=ua!==undefined?letters[Number(ua)]+'. '+opts[Number(ua)]:'æœªä½œç­”'; }
    else if (q.type==='multiple') { correctStr=(Array.isArray(ca)?ca:[]).map(i=>letters[Number(i)]).join('ã€'); userStr=Array.isArray(ua)?ua.map(i=>letters[Number(i)]).join('ã€'):'æœªä½œç­”'; }
    else if (q.type==='truefalse') { correctStr=ca?'æ­£ç¡®':'é”™è¯¯'; userStr=ua!==undefined?(ua?'æ­£ç¡®':'é”™è¯¯'):'æœªä½œç­”'; }
    else if (q.type==='fill') { correctStr=String(ca); userStr=ua||'æœªä½œç­”'; }

    const sources = (data._sources||{})[q.id] || [];
    let sourceHtml = '';
    if (sources.length) {
      sourceHtml = sources.map(s => `
        <details class="source-panel">
          <summary>ğŸ“ æ¥æºï¼š[${esc(s.timestamp)}] ${esc(s.title)}</summary>
          <div class="content">${esc(s.content)}</div>
        </details>
      `).join('');
    }

    const div = document.createElement('div');
    div.className = 'card';
    div.style.borderLeft = '3px solid ' + (resp.is_correct ? 'var(--success)' : 'var(--danger)');
    div.innerHTML = `
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
        <span style="font-weight:700;color:${resp.is_correct?'var(--success)':'var(--danger)'};">${resp.is_correct?'âœ“':'âœ—'}</span>
        <span style="font-size:13px;color:#a1a1aa;">${idx+1}.</span>
      </div>
      <p style="font-size:14px;font-weight:500;margin-bottom:8px;">${esc(q.question)}</p>
      <div style="font-size:13px;line-height:1.8;">
        <p>ä½ çš„ç­”æ¡ˆï¼š<span style="color:${resp.is_correct?'var(--success)':'var(--danger)'};">${esc(userStr)}</span></p>
        ${!resp.is_correct ? '<p>æ­£ç¡®ç­”æ¡ˆï¼š<span style="color:var(--success);">'+esc(correctStr)+'</span></p>' : ''}
      </div>
      ${q.explanation ? '<div class="explanation">ğŸ’¡ '+esc(q.explanation)+'</div>' : ''}
      ${sourceHtml}
    `;
    el.appendChild(div);
  });
}

// ============ Utils ============
function esc(s) {
  if (!s) return '';
  const d = document.createElement('div');
  d.textContent = String(s);
  return d.innerHTML;
}
</script>
</body>
</html>
